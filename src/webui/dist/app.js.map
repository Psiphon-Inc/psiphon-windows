{"version":3,"sources":["../js/main.js"],"names":["window","$window","$","LANGUAGE_CHANGE_EVENT","UI_READY_EVENT","CONNECTED_STATE_CHANGE_EVENT","IS_BROWSER","g_initObj","Cookies","uriHash","location","hash","length","JSON","parse","decodeURIComponent","slice","Config","ClientVersion","Language","Banner","InfoURL","NewVersionEmail","NewVersionURL","FaqURL","DataCollectionInfoURL","DpiScaling","Debug","stringify","AvailableEgressRegions","console","log","overallInit","compareIEVersion","remove","attr","on","updateLogoConnectState","click","e","preventDefault","HtmlCtrlInterface_BannerClick","updateLinks","nextTickFn","defaultLang","siteLangs","currentLang","i18n","lng","replaceLang","_","includes","url","replaceFn","match","p1","p2","replace","regex","text","lastWindowHeight","height","lastWindowWidth","width","smartresize","nextTick","resizeContent","initScrollFix","setTimeout","HtmlCtrlInterface_AppReady","DEBUG_LOG","updateDpiScaling","fillHeight","innerHeight","position","top","footerHeight","outerHeight","parentsUntil","add","siblings","css","trigger","doMatchHeight","doMatchWidth","g_isRTL","outerWidth","dpiScaling","andResizeContent","ltrTransformOrigin","ltrBottomRightTransformOrigin","rtlTransformOrigin","rtlBottomRightTransformOrigin","getIEVersion","transformOrigin","bottomRightTransformOrigin","toFixed","defaultLeftMargin","scaledLeftMargin","each","basePosition","left","scroll","scrollTop","newSrc","stoppedSrc","connectedSrc","data","g_lastState","prop","g_connectingTooLongTimeout","connectionInit","connectToggleSetup","egressRegionComboSetup","hasClass","resizeConnectContent","textfill","maxFontPixels","parentWidth","parent","innerWidth","parseFloat","right","buttonConnectState","parents","HtmlCtrlInterface_StartTunnel","HtmlCtrlInterface_StopTunnel","updateConnectToggle","toggleClass","cycleToggleClass","updateConnectAttemptTooLong","clearTimeout","connectAttemptTooLongReset","connectAttemptTooLong","addClass","removeClass","elem","cls","untilStateChangeFrom","cycleToggleClass_inner","html","egressRegionComboSetup_EgressRegionCombo_click","region","refreshSettings","EgressRegion","applySettings","egressRegionComboSetup_EgressRegion_change","$activeItem","$regionItems","i","$regionItem","eq","hidden","active","find","showSettingsSection","SETTING_CHANGED_EVENT","BEST_REGION_VALUE","settingsInit","Settings","SplitTunnel","DisableTimeouts","VPN","LocalHttpProxyPort","LocalSocksProxyPort","SkipUpstreamProxy","UpstreamProxyHostname","UpstreamProxyPort","UpstreamProxyUsername","UpstreamProxyPassword","UpstreamProxyDomain","SystrayMinimize","DisableDisallowedTrafficAlert","defaults","onSettingChanged","onSettingsReset","onSettingsApply","onSettingsTabShown","is","onSettingsTabHiding","headingSelector","id","$expandIcon","blur","systrayMinimizeSetup","disableDisallowedTrafficSetup","splitTunnelSetup","disableTimeoutsSetup","egressRegionSetup","localProxySetup","upstreamProxySetup","vpnModeSetup","updateAvailableEgressRegions","one","enableSettingsApplyButton","getSettingsApplyButtonEnabled","$modal","modal","show","backdrop","off","target","tab","showSettingsErrorModal","settingsValues","getSettingsTabValues","settingsChanged","settingsObjectChanged","switchToTab","newSettings","key","keys","enable","$applyButton","currentlyEnabled","removeAttr","drawAttentionToButton","HtmlCtrlInterface_SaveSettings","forceCurrent","fullNewSettings","extend","fillSettingsValues","forceEgressRegionValid","obj","isUndefined","vpnModeUpdate","val","localProxyValid","skipUpstreamProxyUpdate","upstreamProxyValid","ignoreDisabled","valid","egressRegionValid","egressRegion","returnValue","validatePort","showNoticeModal","showSettingErrorSection","focus","change","extraArgs","$currRegionElem","updateErrorAlert","forceValid","regions","getCookie","elemRegion","event","delay","bind","httpPort","socksPort","unique","localProxyPortConflictNotice","noticeType","bodyKey","skip","needHostname","Boolean","needUsername","portOK","skipUpstreamProxy","g_upstreamProxyErrorNoticeTimer","upstreamProxyErrorNotice","errorMessage","vpn","intVal","parseInt","isNaN","toString","section","focusElem","onTabShown","collapse","not","scrollTo","duration","offset","onAfter","sendFeedback","smileyResponses","push","title","question","answer","fields","responses","feedback","email","sendDiagnosticInfo","HtmlCtrlInterface_SendFeedback","displayCornerAlert","showDebugLogsClicked","addLog","loadTemplate","timestamp","Date","toLocaleTimeString","message","priority","prepend","priorities","MAX_LOGS_PER_PRIORITY","debugLogHelper","Array","prototype","call","arguments","DEBUG_WARN","warn","consoleLogger","args","msg","isString","logger","apply","RTL_LOCALES","fallbackLanguage","lang","init","fallbackLng","resStore","PSIPHON","LOCALES","switchLocale","populateLocales","g_languageSuccessAlertShown","locale","initial","setLng","setCookie","rtl","contains","ltrClasses","rtlClasses","translation","en","appBackendStringTable","hasOwnProperty","startsWith","t","HtmlCtrlInterface_AddStringTableItem","localePriorityGuide","locales","map","sort","a","b","localePriority_a","indexOf","localePriority_b","$localeListElem","localeCode","localeName","name","append","PsiCashEventTypeEnum","REFRESH","NEW_PURCHASE","INIT_DONE","PsiCashServerResponseStatus","Invalid","Success","ExistingTransaction","InsufficientBalance","TransactionAmountMismatch","TransactionTypeNotFound","InvalidTokens","ServerError","PsiCashCommandEnum","PURCHASE","PsiCashCommandBase","command","randomID","PsiCashCommandRefresh","reason","create","constructor","PsiCashCommandPurchase","transactionClass","distinguisher","expectedPrice","PsiCashMessageTypeEnum","PsiCashStore","Datastore","initDone","purchaseInProgress","psicashInit","addWindowFocusHandler","HtmlCtrlInterface_PsiCashCommand","psiCashLibraryInitDone","evt","error","recovered","set","psiCashStateInitialized","psicashData","g_PsiCashData","valid_token_types","isNumber","balance","PSICASH_ENABLED_COOKIE","refreshPsiCashEventHandler","psiCashUIUpdater","PsiCashUIState","ZERO_BALANCE","uiSelector","NSF_BALANCE","ENOUGH_BALANCE","BUYING_BOOST","ACTIVE_BOOST","VPN_MODE_DISABLED","timeout","HtmlCtrlInterface_Log","veryFirstUpdate","windowHasFocus","buy_psi_url","urlComp","urlComponents","search","href","sbPrices","purchase_prices","pp","price","formatPsi","state","nsf1Day","millisOfSpeedBoostRemaining","purchases","localTimeExpiry","moment","isAfter","diff","Math","max","boostRemainingTime","momentLocale","humanize","boostRemainingText","PsiCashBalanceChange","doBalanceChange","newBalance","allDoneDefer","Deferred","previousBalance","startingPoint","balanceDiff","resolve","BILLION","balanceStepTime","balanceStopInterval","maxSteps","trunc","gigaBalanceDiff","balanceStepCount","min","abs","balanceStepSize","extraStepSize","sign","intermediateBalance","$visiblePsiCashInterface","$visibleBalanceElem","tickDefer","deltaDefer","when","promise","always","finalTickStep","balanceTickInterval","clearInterval","setInterval","psiText","$deltaElem","insertAfter","animationCSSEnpoint","animationPromise","animate","easing","queue","_queue","_first","PsiCashBalanceChange_push","first","_pop","PsiCashBalanceChange_pop","nextBalance","changePromise","shift","toLowerCase","subLocale","split","exactLocaleMatch","subLocaleMatch","momentLocales","l","buySpeedBoostClick","then","result","refresh","status","HtmlCtrlInterface_ReconnectTunnel","Error","buyPsiClick","nanopsi","currLang","psi","floor","toLocaleString","substring","handleDisallowedTrafficNotice","uiState","alertDisallowedTraffic","HtmlCtrlInterface_DisallowedTraffic","psicashBlock","subscribe","boosting","appearAnimationTime","showingTime","disappearAnimationTime","toggle","horizFirst","callback","$tab","titleKey","techPreambleKey","techInfoString","closedCallback","DEBUG_ASSERT","j","$elem","matchSelector","matchSelectorsToMaxHeight","$matchSelectorMatches","$elemsToChange","matchHeight","heightDiff","align","matchSelectors","$dataMatchElems","$matchMaxElems","matchSelectorMaxWidth","unshift","getNetWidth","grossWidth","ie7_10Match","ie11Match","edgeMatch","tridentMatch","msieMatch","ieVersion","navigator","userAgent","comparison","targetVersion","acceptNonIE","g_cookies","localStorage","getItem","value","setItem","HtmlCtrlInterface_SetCookies","context","nextTickFnInner","runner","hexToRgb","hex","shorthandRegex","m","r","g","exec","backgroundColor","backgroundColorRGB","shadowColor","originalBoxShadow","animationTimeSecs","check","isFunction","document","hasFocus","handler","base64","encode","random","parser","createElement","debugInit","HtmlCtrlInterface_SetState","updateStateCombo","HtmlCtrlInterface_AddLog","regionCheckboxes","HtmlCtrlInterface_AddNotice","HtmlCtrlInterface_UpdateDpiScaling","debugRefreshPsiCashClick","makeTestRefreshMsg","HtmlCtrlInterface_PsiCashMessage","payload","debugPsiCashInitDoneClick","testInitDoneResponse","msg_id","purchase","toISOString","type","makeTestRefreshPayload","checked","testRefreshResponse","testPurchaseResponse","resp","msgPayload","expiry","serverTimeExpiry","debugSetPsiCashData","Object","assign","PSIPHON_LINK_PREFIX","jsonArgs","isObject","setProxyWarningTemplate","template","g_timeoutSetState","HtmlCtrlInterface_RefreshSettings","settings","success","reconnectRequired","g_PsiCashCommandIDToResolver","appURL","stringtable","item","string","sendStringTableItem","itemObj","encodeURIComponent","join","suppressHomePage","settingsJSON","feedbackJSON","cookiesJSON","alert","commandJSON","Promise"],"mappings":"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","sourcesContent":["/*\n * Copyright (c) 2015, Psiphon Inc.\n * All rights reserved.\n *\n * This program is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with this program.  If not, see <http://www.gnu.org/licenses/>.\n *\n */\n\n(function(window) {\n  \"use strict\";\n  /* jshint strict:true, newcap:false */\n\n  /* GENERAL */\n\n  var $window = $(window);\n\n  // Fired on the window when the UI language changes\n  var LANGUAGE_CHANGE_EVENT = 'language-change';\n\n  // Fired on the window when HTML interface declares itself ready.\n  var UI_READY_EVENT = 'ui-ready';\n\n  // Fired on the window when the connected state changes\n  var CONNECTED_STATE_CHANGE_EVENT = 'connected-state-change';\n\n  // We often test in-browser and need to behave a bit differently\n  var IS_BROWSER = true;\n\n  // Parse whatever JSON parameters were passed by the application.\n  var g_initObj = { Cookies: {} };\n  (function() {\n    var uriHash = location.hash;\n    if (uriHash && uriHash.length > 1) {\n      g_initObj = JSON.parse(decodeURIComponent(uriHash.slice(1)));\n      IS_BROWSER = false;\n    }\n\n    // For browser debugging\n    if (IS_BROWSER) {\n      g_initObj = g_initObj || {};\n      g_initObj.Config = g_initObj.Config || {};\n      g_initObj.Config.ClientVersion = g_initObj.Config.ClientVersion || '99';\n      g_initObj.Config.Language = g_initObj.Config.Language || 'en';\n      g_initObj.Config.Banner = g_initObj.Config.Banner || 'banner.png';\n      g_initObj.Config.InfoURL =\n        g_initObj.Config.InfoURL || 'http://example.com/browser-InfoURL/index.html';\n      g_initObj.Config.NewVersionEmail =\n        g_initObj.Config.NewVersionEmail || 'browser-NewVersionEmail@example.com';\n      g_initObj.Config.NewVersionURL =\n        g_initObj.Config.NewVersionURL || 'http://example.com/browser-NewVersionURL/en/download.html#direct';\n      g_initObj.Config.FaqURL = g_initObj.Config.FaqURL || 'http://example.com/browser-FaqURL/en/faq.html';\n      g_initObj.Config.DataCollectionInfoURL =\n        g_initObj.Config.DataCollectionInfoURL || 'http://example.com/browser-DataCollectionInfoURL/en/privacy.html#information-collected';\n      g_initObj.Config.DpiScaling = 1.0;\n      g_initObj.Config.Debug = g_initObj.Config.Debug || true;\n\n      g_initObj.Cookies = JSON.stringify({\n        AvailableEgressRegions: ['US', 'GB', 'JP', 'NL', 'DE']\n      });\n\n      console.log(g_initObj);\n    }\n  })();\n\n  $(function overallInit() {\n    // Do some browser-version-dependent DOM pruning\n    if (compareIEVersion('lte', 7, false)) {\n      $('.ie7Remove').remove();\n    }\n\n    // Set the logo \"info\" link\n    $('.logo a').attr('href', g_initObj.Config.InfoURL).attr('title', g_initObj.Config.InfoURL);\n\n    // Update the logo when the connected state changes\n    $window.on(CONNECTED_STATE_CHANGE_EVENT, updateLogoConnectState);\n    updateLogoConnectState();\n\n    // The banner image filename is parameterized.\n    $('.banner img').attr('src', g_initObj.Config.Banner);\n    // Let the C-code decide what should be opened when the banner is clicked.\n    $('.banner a').click(function(e) {\n      e.preventDefault();\n      HtmlCtrlInterface_BannerClick();\n    });\n\n    // Links to the download site and email address are parameterized and need to\n    // be updated when the language changes.\n    var updateLinks = nextTickFn(function updateLinks() {\n      // For some languages we alter the \"download site\" links to point directly\n      // to that language. But the site has different available languages than\n      // this application does, so we don't just do it blindly.\n      var defaultLang = 'en';\n      var siteLangs = ['fa', 'zh'];\n      var currentLang = i18n.lng();\n      var replaceLang = _.includes(siteLangs, currentLang) ? currentLang : defaultLang;\n      var url;\n\n      // Note that we're using the function-as-replacement form for String.replace()\n      // because we don't entirely control the content of the language names, and\n      // we don't want to run into any issues with magic values:\n      // https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/String/replace#Specifying_a_string_as_a_parameter\n\n      var replaceFn = function(match, p1, p2) {\n          return p1 + '/' + replaceLang + '/' + p2;\n        };\n\n      // This link may be to the redirect meta page (/index.html) or to a language-specific\n      // page (/en/index.html). If it's to the meta page, we won't force to English, otherwise we will.\n      // First change it to the meta page if it's not already\n      url = g_initObj.Config.InfoURL.replace('/en/', '/');\n      // Then force the language, but not to English\n      if (replaceLang !== defaultLang) {\n        // We're using the function form of\n        url = g_initObj.Config.InfoURL.replace(/^([^?#]*)\\/(.*)$/, replaceFn);\n      }\n      $('.InfoURL').attr('href', url).attr('title', url);\n\n      var regex = /^([^?#]*)\\/en\\/(.*)$/;\n\n      url = g_initObj.Config.NewVersionURL.replace(regex, replaceFn);\n      $('.NewVersionURL').attr('href', url).attr('title', url);\n\n      url = g_initObj.Config.FaqURL.replace(regex, replaceFn);\n      $('.FaqURL').attr('href', url).attr('title', url);\n\n      url = g_initObj.Config.DataCollectionInfoURL.replace(regex, replaceFn);\n      $('.DataCollectionInfoURL').attr('href', url).attr('title', url);\n\n      // No replacement on the email address\n      $('.NewVersionEmail').attr('href', 'mailto:' + g_initObj.Config.NewVersionEmail)\n                           .text(g_initObj.Config.NewVersionEmail)\n                           .attr('title', g_initObj.Config.NewVersionEmail);\n\n      $('.ClientVersion').text(g_initObj.Config.ClientVersion);\n    });\n    $window.on(LANGUAGE_CHANGE_EVENT, updateLinks);\n    // ...and now.\n    updateLinks();\n\n    // Update the size of our tab content element when the window resizes...\n    var lastWindowHeight = $window.height();\n    var lastWindowWidth = $window.width();\n    $window.smartresize(function() {\n      // Only go through the resize logic if the window actually changed size.\n      // This helps with the constant resize events we get with IE7.\n      if (lastWindowHeight !== $window.height() ||\n          lastWindowWidth !== $window.width()) {\n        lastWindowHeight = $window.height();\n        lastWindowWidth = $window.width();\n        nextTick(resizeContent);\n      }\n    });\n    // ...and when a tab is activated...\n    $('a[data-toggle=\"tab\"]').on('shown', function() {\n      nextTick(resizeContent);\n    });\n    // ...and when the language changes...\n    $window.on(LANGUAGE_CHANGE_EVENT, nextTickFn(resizeContent));\n    // ...and now.\n    resizeContent();\n\n    // We don't want buggy scrolling behaviour (which can result from some click-drag selecting)\n    initScrollFix();\n\n    setTimeout(HtmlCtrlInterface_AppReady, 100);\n  });\n\n\n  function resizeContent() {\n    DEBUG_LOG('resizeContent called');\n\n    // Do DPI scaling\n    updateDpiScaling(g_initObj.Config.DpiScaling, false);\n\n    // We want the content part of our window to fill the window, we don't want\n    // excessive scroll bars, etc. It's difficult to do \"fill the remaining height\"\n    // with just CSS, so we're going to do some on-resize height adjustment in JS.\n    var fillHeight = $window.innerHeight() - $('.main-height').position().top;\n    var footerHeight = $('.footer').outerHeight();\n    $('.main-height').outerHeight((fillHeight - footerHeight) / g_initObj.Config.DpiScaling);\n    $('.main-height').parentsUntil('body').add($('.main-height').siblings()).css('height', '100%');\n\n    // Let the panes know that content resized\n    $('.main-height').trigger('resize');\n\n    doMatchHeight();\n    doMatchWidth();\n\n    // Adjust the banner to account for the logo space.\n    $('.banner').css(g_isRTL ? 'margin-right' : 'margin-left', $('.header-nav-join').outerWidth())\n                .css(!g_isRTL ? 'margin-right' : 'margin-left', 0);\n  }\n\n  function updateDpiScaling(dpiScaling, andResizeContent/*=true*/) {\n    DEBUG_LOG('updateDpiScaling: ' + dpiScaling);\n    g_initObj.Config.DpiScaling = dpiScaling;\n\n    if (compareIEVersion('lt', 9, false)) {\n      // We need IE9+ to support DPI scaling\n      return;\n    }\n\n    var ltrTransformOrigin = '0 0 0',\n        ltrBottomRightTransformOrigin = '100% 100% 0',\n        rtlTransformOrigin = '0 0 0',\n        rtlBottomRightTransformOrigin = '0 100% 0';\n\n    if (getIEVersion() === false && g_isRTL) {\n      // Non-IE in RTL need the origin on the right.\n      rtlTransformOrigin = '100% 0 0';\n    }\n\n    var transformOrigin = g_isRTL ? rtlTransformOrigin : ltrTransformOrigin,\n        bottomRightTransformOrigin = g_isRTL ? rtlBottomRightTransformOrigin : ltrBottomRightTransformOrigin;\n\n    // Set the overall body scaling\n    $('html').css({\n      'transform-origin': transformOrigin,\n      'transform': 'scale(' + dpiScaling + ')',\n      'width': (100.0 / dpiScaling).toFixed(1) + '%',\n      'height': (100.0 / dpiScaling).toFixed(1) + '%'\n    });\n\n    // For elements (like modals) outside the normal flow, additional changes are needed.\n    if (getIEVersion() !== false) {\n      // The left margin will vary depending on default value.\n      // First reset an overridden left margin\n      $('.modal').css('margin-left', '');\n      // Get the default left margin\n      var defaultLeftMargin = $('.modal').css('margin-left');\n      // Create the left margin we want, based on the default\n      var scaledLeftMargin = 'calc(' + defaultLeftMargin + ' * ' + dpiScaling + ')';\n      // Now apply the styles.\n      $('.modal').css({\n        'transform-origin': transformOrigin,\n        'transform': 'scale(' + dpiScaling + ')',\n        'margin-left': scaledLeftMargin\n      });\n    }\n\n    $('.global-alert').css({\n      'transform-origin': bottomRightTransformOrigin,\n      'transform': 'scale(' + dpiScaling + ')'\n    });\n\n    // Elements with the `affix` class are position:fixed and need to be adjusted separately\n    if (getIEVersion() !== false) {\n      // Reset previous position modification.\n      $('.affix')\n        .css({'top': '', 'left': ''})\n        .each(function() {\n          var basePosition = $(this).position();\n          $(this).css({\n            'transform-origin': transformOrigin,\n            'transform': 'scale(' + dpiScaling + ')'\n          });\n          if (basePosition.top) {\n            $(this).css({\n              'top': (basePosition.top * dpiScaling) + 'px'\n            });\n          }\n          if (basePosition.left) {\n            $(this).css({\n              'left': (basePosition.left * dpiScaling) + 'px'\n            });\n          }\n        });\n    }\n\n    if (andResizeContent !== false) {\n      // Need to resize everything.\n      nextTick(resizeContent);\n    }\n  }\n\n  // Ensures that elements that should not be scrolled are not scrolled.\n  // This should only be called once.\n  function initScrollFix() {\n    // It would be much better to fix this correctly using CSS rather than\n    // detecting a bad state and correcting it. But until we figure that out...\n    $('body').scroll(function() {\n      $('body').scrollTop(0);\n    });\n  }\n\n\n  // Update the main connect button, as well as the connection indicator on the tab.\n  function updateLogoConnectState() {\n    var newSrc, stoppedSrc, connectedSrc;\n    stoppedSrc = $('.logo img').data('stopped-src');\n    connectedSrc = $('.logo img').data('connected-src');\n\n    if (g_lastState === 'connected') {\n      newSrc = connectedSrc;\n    }\n    else {\n      newSrc = stoppedSrc;\n    }\n\n    $('.logo img').prop('src', newSrc);\n  }\n\n\n  /* CONNECTION ****************************************************************/\n\n  // The current connected actual state of the application\n  var g_lastState = 'stopped';\n\n  // Used to monitor whether the current connection attempt is taking too long and\n  // so if a \"download new version\" message should be shown.\n  var g_connectingTooLongTimeout = null;\n\n  $(function connectionInit() {\n    connectToggleSetup();\n    egressRegionComboSetup();\n\n    // Update the size of our elements when the tab content element resizes...\n    $('.main-height').on('resize', function() {\n      // Only if this tab is active\n      if ($('#connection-pane').hasClass('active')) {\n        nextTick(resizeConnectContent);\n      }\n    });\n    // ...and when the tab is activated...\n    $('a[href=\"#connection-pane\"][data-toggle=\"tab\"]').on('shown', function() {\n      nextTick(resizeConnectContent);\n    });\n    // ...and now.\n    resizeConnectContent();\n  });\n\n  function resizeConnectContent() {\n    // Resize the text in the button\n    $('.textfill-container').textfill({ maxFontPixels: -1 });\n\n    // Set the outer connect button div to the correct height\n    $('#connect-toggle').height($('#connect-toggle > *').outerHeight());\n\n    // Center the connect button div\n    var parentWidth = $('#connect-toggle').parent().innerWidth() -\n                        (parseFloat($('#connect-toggle').parent().css('padding-left')) || 0) -\n                        (parseFloat($('#connect-toggle').parent().css('padding-right')) || 0);\n    if (g_isRTL) {\n      $('#connect-toggle').css({\n        right: ((parentWidth - $('#connect-toggle').outerWidth()) / 2.0)+'px',\n        left: ''\n      });\n    }\n    else {\n      $('#connect-toggle').css({\n        left: ((parentWidth - $('#connect-toggle').outerWidth()) / 2.0)+'px',\n        right: ''\n      });\n    }\n  }\n\n  function connectToggleSetup() {\n    $('#connect-toggle a').click(function(e) {\n      e.preventDefault();\n      var buttonConnectState = $(this).parents('.connect-toggle-content').data('connect-state');\n      if (buttonConnectState === 'stopped') {\n        HtmlCtrlInterface_StartTunnel();\n      }\n      else if (buttonConnectState === 'starting' || buttonConnectState === 'connected') {\n        HtmlCtrlInterface_StopTunnel();\n      }\n      // the stopping button is disabled\n    });\n    updateConnectToggle();\n\n    $('.textfill-container').textfill({ maxFontPixels: -1 });\n\n    // Update the button when the back-end tells us the state has changed.\n    $window.on(CONNECTED_STATE_CHANGE_EVENT, nextTickFn(updateConnectToggle));\n  }\n\n  // Update the main connect button, as well as the connection indicator on the tab.\n  function updateConnectToggle() {\n    $('.connect-toggle-content').each(function() {\n      $(this).toggleClass('z-behind', $(this).data('connect-state') !== g_lastState);\n    });\n\n    $('a[href=\"#connection-pane\"][data-toggle=\"tab\"] [data-connect-state]').each(function() {\n      $(this).toggleClass('z-behind', $(this).data('connect-state') !== g_lastState);\n    });\n\n    if (g_lastState === 'starting') {\n      cycleToggleClass(\n        $('.connect-toggle-content[data-connect-state=\"starting\"] .icon-spin, .connect-toggle-content[data-connect-state=\"starting\"] .state-word'),\n        'in-progress',\n        g_lastState);\n    }\n    else if (g_lastState === 'connected') {\n      // No additional work\n    }\n    else if (g_lastState === 'stopping') {\n      cycleToggleClass(\n        $('.connect-toggle-content[data-connect-state=\"stopping\"] .icon-spin, .connect-toggle-content[data-connect-state=\"stopping\"] .state-word'),\n        'in-progress',\n        g_lastState);\n    }\n    else if (g_lastState === 'stopped') {\n      // No additional work\n    }\n\n    updateConnectAttemptTooLong();\n  }\n\n  // Keeps track of how long the current connection attempt is taking and whether\n  // a message should be shown to the user indicating how to get a new version.\n  function updateConnectAttemptTooLong() {\n    if (g_lastState === 'connected' || g_lastState === 'stopped') {\n      // Clear the too-long timeout\n      if (g_connectingTooLongTimeout !== null) {\n        clearTimeout(g_connectingTooLongTimeout);\n        g_connectingTooLongTimeout = null;\n        connectAttemptTooLongReset();\n      }\n    }\n    else {\n      // Start the too-long timeout\n      if (g_connectingTooLongTimeout === null) {\n        g_connectingTooLongTimeout = setTimeout(connectAttemptTooLong, 60000);\n      }\n    }\n\n    function connectAttemptTooLong() {\n      $('.long-connecting-hide').addClass('hidden');\n      $('.long-connecting-show').removeClass('hidden');\n    }\n\n    function connectAttemptTooLongReset() {\n      $('.long-connecting-hide').removeClass('hidden');\n      $('.long-connecting-show').addClass('hidden');\n    }\n  }\n\n  function cycleToggleClass(elem, cls, untilStateChangeFrom) {\n    $(elem).toggleClass(cls, 1000, function() {\n      if (g_lastState === untilStateChangeFrom) {\n        nextTick(function cycleToggleClass_inner() {\n          cycleToggleClass(elem, cls, untilStateChangeFrom);\n        });\n      }\n    });\n  }\n\n  function egressRegionComboSetup() {\n    // Rather than duplicating the markup of the settings' egress region list,\n    // we're going to copy it now.\n    // IE7: Don't use $().clone().\n    $('#EgressRegionCombo ul').html($('ul#EgressRegion').html());\n\n    // When an item in the combo is clicked, make the settings code do the work.\n    $('#EgressRegionCombo ul a').click(function egressRegionComboSetup_EgressRegionCombo_click(e) {\n      e.preventDefault();\n      var region = $(this).parents('[data-region]').data('region');\n      if (!region) {\n        return;\n      }\n\n      refreshSettings({\n        EgressRegion: region\n      });\n\n      applySettings();\n    });\n\n    // Have the combobox track the state of the control in the settings pane.\n    $('#EgressRegion').on('change', function egressRegionComboSetup_EgressRegion_change() {\n      var $activeItem;\n      // Copy the relevant classes to the combo items from the settings items.\n      var $regionItems = $('#EgressRegion li');\n      for (var i = 0; i < $regionItems.length; i++) {\n        var $regionItem = $regionItems.eq(i);\n        var region = $regionItem.data('region');\n        var hidden = $regionItem.hasClass('hidden');\n        var active = $regionItem.hasClass('active');\n\n        $('#EgressRegionCombo li[data-region=\"' + region + '\"]')\n          .toggleClass('hidden', hidden)\n          .toggleClass('active', active);\n\n        if (active) {\n          $activeItem = $regionItem;\n        }\n      }\n\n      // Update the button\n      if ($activeItem) {\n        $('#EgressRegionCombo .btn span.flag')\n          .attr('data-i18n', $activeItem.find('a').data('i18n'))\n          .attr('class', $activeItem.find('a').attr('class'))\n          .text($activeItem.find('a').text());\n      }\n    });\n\n    // If the label is clicked, jump to the Egress Region settings section\n    $('.egress-region-combo-container label a').click(function(e) {\n      e.preventDefault();\n      showSettingsSection('#settings-accordion-egress-region');\n      return false;\n    });\n  }\n\n\n  /* SETTINGS ******************************************************************/\n\n  // Event fired on #settings-pane when a setting is changed.\n  var SETTING_CHANGED_EVENT = 'setting-changed';\n\n  var BEST_REGION_VALUE = 'BEST';\n\n  $(function settingsInit() {\n    // This is merely to help with testing\n    if (!g_initObj.Settings)\n    {\n      g_initObj.Settings = {\n        SplitTunnel: 0,\n        DisableTimeouts: 0,\n        VPN: 0,\n        LocalHttpProxyPort: 7771,\n        LocalSocksProxyPort: 7770,\n        SkipUpstreamProxy: 1,\n        UpstreamProxyHostname: 'upstreamhost',\n        UpstreamProxyPort: 234,\n        UpstreamProxyUsername: 'user',\n        UpstreamProxyPassword: 'password',\n        UpstreamProxyDomain: 'domain',\n        EgressRegion: 'GB',\n        SystrayMinimize: 0,\n        DisableDisallowedTrafficAlert: 0,\n        defaults: {\n          SplitTunnel: 0,\n          DisableTimeouts: 0,\n          VPN: 0,\n          LocalHttpProxyPort: '',\n          LocalSocksProxyPort: '',\n          SkipUpstreamProxy: 0,\n          UpstreamProxyHostname: '',\n          UpstreamProxyPort: '',\n          UpstreamProxyUsername: '',\n          UpstreamProxyPassword: '',\n          UpstreamProxyDomain: '',\n          EgressRegion: '',\n          SystrayMinimize: 0,\n          DisableDisallowedTrafficAlert: 0\n        }\n      };\n    }\n\n    // Event handlers\n    $('#settings-pane').on(SETTING_CHANGED_EVENT, onSettingChanged);\n    $('.settings-buttons .reset-settings').click(onSettingsReset);\n    $('.settings-buttons .apply-settings').click(onSettingsApply);\n    $('a[href=\"#settings-pane\"][data-toggle=\"tab\"]').on('shown', onSettingsTabShown);\n    $('a[data-toggle=\"tab\"]').on('show', function(e) {\n      if ($('#settings-tab').hasClass('active') &&    // we were active\n          !$(this).parent().is($('#settings-tab'))) { // we won't be active\n        onSettingsTabHiding(e);\n      }\n    });\n\n    // Change the accordion heading icon on expand/collapse\n    $('.accordion-body')\n      .on('show', function() {\n        var headingSelector = '.accordion-toggle[href=\"#' + this.id + '\"]';\n        $(headingSelector).addClass('accordion-expanded');\n        var $expandIcon = $(headingSelector).find('.accordion-expand-icon');\n        $expandIcon.removeClass($expandIcon.data('icon-closed'))\n                   .addClass($expandIcon.data('icon-opened'));\n\n        // Remove focus from the heading to clear the text-decoration. (It's too\n        // ham-fisted to do it in CSS.)\n        $(headingSelector).blur();\n      })\n      .on('hide', function() {\n        var headingSelector = '.accordion-toggle[href=\"#' + this.id + '\"]';\n        $(headingSelector).removeClass('accordion-expanded');\n        var $expandIcon = $(headingSelector).find('.accordion-expand-icon');\n        $expandIcon.removeClass($expandIcon.data('icon-opened'))\n                   .addClass($expandIcon.data('icon-closed'));\n\n        // Remove focus from the heading to clear the text-decoration. (It's too\n        // ham-fisted to do it in CSS.)\n        $(headingSelector).blur();\n      });\n\n    systrayMinimizeSetup();\n    disableDisallowedTrafficSetup();\n    splitTunnelSetup();\n    disableTimeoutsSetup();\n    egressRegionSetup();\n    localProxySetup();\n    upstreamProxySetup();\n    vpnModeSetup();\n\n    updateAvailableEgressRegions(false); // don't force valid -- haven't filled in settings yet\n\n    $window.one(UI_READY_EVENT, function() {\n      // Fill in the settings. This must be done after the UI is ready, since it might\n      // show an error, requiring i18n to be initialized.\n      refreshSettings();\n    });\n  });\n\n  //\n  // Overall event handlers\n  //\n\n  // Settings tab has been navigated to and is shown\n  function onSettingsTabShown() {\n    // Reset the Apply button\n    enableSettingsApplyButton(false);\n  }\n\n  // Settings tab is showing, but is being navigated away from.\n  // Call e.preventDefault() to prevent navigation away.\n  function onSettingsTabHiding(e) {\n    // If the settings have been changed and not applied, prevent navigating away\n    // and prompt the user for how it should be resolved.\n    if (getSettingsApplyButtonEnabled()) {\n      e.preventDefault();\n\n      var $modal = $('#SettingsUnappliedChangesPrompt');\n\n      $modal.modal({\n        show: true,\n        backdrop: 'static'\n      });\n\n      // Note: If we don't first remove existing click handlers (with .off), then\n      // the handler that wasn't clicked last time will still be present.\n\n      $modal.find('.apply-button').off('click').one('click', function() {\n        $modal.modal('hide');\n        if (applySettings()) {\n          enableSettingsApplyButton(false);\n          $(e.target).tab('show');\n        }\n        else {\n          showSettingsErrorModal();\n        }\n      });\n\n      $modal.find('.discard-button').off('click').one('click', function() {\n        $modal.modal('hide');\n        refreshSettings(g_initObj.Settings);\n        enableSettingsApplyButton(false);\n        $(e.target).tab('show');\n      });\n    }\n  }\n\n  // A setting value has been changed.\n  function onSettingChanged(e, id) {\n    DEBUG_LOG('onSettingChanged: ' + id);\n\n    var settingsValues = getSettingsTabValues();\n\n    if (settingsValues === false) {\n      // Settings values are invalid\n      enableSettingsApplyButton(false);\n    }\n    else {\n      var settingsChanged = settingsObjectChanged(settingsValues);\n      enableSettingsApplyButton(settingsChanged);\n    }\n  }\n\n  // Handler for the Reset Settings button\n  function onSettingsReset(e) {\n    /*jshint validthis:true */\n\n    e.preventDefault();\n    $(this).blur();\n\n    refreshSettings(g_initObj.Settings.defaults, false);\n\n    // Force the Apply button to be enabled. Otherwise the user might be confused\n    // about how to make the Reset take effect.\n    enableSettingsApplyButton(true);\n  }\n\n  // Handler for the Apply Settings button\n  function onSettingsApply(e) {\n    /*jshint validthis:true */\n\n    e.preventDefault();\n    $(this).blur();\n\n    if (!getSettingsApplyButtonEnabled()) {\n      return;\n    }\n\n    if (applySettings()) {\n      // Reset the Apply button\n      enableSettingsApplyButton(false);\n\n      // Switch to Connection tab\n      switchToTab('#connection-tab');\n    }\n    else {\n      showSettingsErrorModal();\n    }\n  }\n\n  //\n  // General settings functions\n  //\n\n  // Returns true if newSettings differs from the current canonical settings.\n  function settingsObjectChanged(newSettings) {\n    // This does not take into account more/fewer keys in the object, since that\n    // should not happen.\n\n    var key, i;\n    var keys = _.keys(g_initObj.Settings);\n    for (i = 0; i < keys.length; i++) {\n      key = keys[i];\n      if (key === 'defaults') {\n        // The defaults object doesn't count in the comparison.\n        continue;\n      }\n\n      if (newSettings[key] !== g_initObj.Settings[key]) {\n        DEBUG_LOG('settingsObjectChanged: detected change: ' + key);\n        return true;\n      }\n    }\n\n    DEBUG_LOG('settingsObjectChanged: no change');\n    return false;\n  }\n\n  function enableSettingsApplyButton(enable) {\n    var $applyButton = $('#settings-pane .apply-settings');\n    var currentlyEnabled = getSettingsApplyButtonEnabled();\n\n    if (enable && !currentlyEnabled) {\n      $applyButton.removeClass('disabled').removeAttr('disabled');\n      drawAttentionToButton($applyButton);\n    }\n    else if (!enable && currentlyEnabled) {\n      $applyButton.addClass('disabled').attr('disabled', true);\n    }\n  }\n\n  function getSettingsApplyButtonEnabled() {\n    var $applyButton = $('#settings-pane .apply-settings');\n    return !$applyButton.hasClass('disabled');\n  }\n\n  // Save the current settings (and possibly reconnect).\n  function applySettings() {\n    var settingsValues = getSettingsTabValues();\n    if (settingsValues === false) {\n      // Settings are invalid.\n      return false;\n    }\n\n    // Update settings in the application (and trigger a reconnect, if\n    // necessary).\n    HtmlCtrlInterface_SaveSettings(JSON.stringify(settingsValues));\n\n    return true;\n  }\n\n  // Refresh the current settings. If newSettings is truthy, it will become the\n  // the new current settings, otherwise the existing current settings will be\n  // refreshed in the UI.\n  // newSettings can be a partial settings object (like, just {egressRegion: \"US\"} or whatever).\n  // If forceCurrent is true, the new settings will be become canonical (rather than just displayed).\n  function refreshSettings(newSettings, forceCurrent) {\n    var fullNewSettings = $.extend(g_initObj.Settings, newSettings || {});\n\n    if (forceCurrent) {\n      g_initObj.Settings = fullNewSettings;\n    }\n\n    fillSettingsValues(fullNewSettings);\n\n    // When the settings change, we need to check the current egress region choice.\n    forceEgressRegionValid();\n    // NOTE: If more checks like this are added, we'll need to chain them (somehow),\n    // otherwise we'll have a mess of modals.\n  }\n\n  // Fill in the settings controls with the values in `obj`.\n  function fillSettingsValues(obj) {\n    // Bit of a hack: Unhook the setting-changed event while we fill in the\n    // values, then hook it up again after.\n    $('#settings-pane').off(SETTING_CHANGED_EVENT, onSettingChanged);\n\n    if (!_.isUndefined(obj.SplitTunnel)) {\n      $('#SplitTunnel').prop('checked', !!obj.SplitTunnel);\n    }\n\n    if (!_.isUndefined(obj.DisableTimeouts)) {\n      $('#DisableTimeouts').prop('checked', !!obj.DisableTimeouts);\n    }\n\n    if (!_.isUndefined(obj.VPN)) {\n      $('#VPN').prop('checked', obj.VPN);\n    }\n    vpnModeUpdate();\n\n    if (!_.isUndefined(obj.LocalHttpProxyPort)) {\n      $('#LocalHttpProxyPort').val(obj.LocalHttpProxyPort > 0 ? obj.LocalHttpProxyPort : '');\n    }\n\n    if (!_.isUndefined(obj.LocalSocksProxyPort)) {\n      $('#LocalSocksProxyPort').val(obj.LocalSocksProxyPort > 0 ? obj.LocalSocksProxyPort : '');\n    }\n\n    localProxyValid(false);\n\n    if (!_.isUndefined(obj.UpstreamProxyHostname)) {\n      $('#UpstreamProxyHostname').val(obj.UpstreamProxyHostname);\n    }\n\n    if (!_.isUndefined(obj.UpstreamProxyPort)) {\n      $('#UpstreamProxyPort').val(obj.UpstreamProxyPort > 0 ? obj.UpstreamProxyPort : '');\n    }\n\n    if (!_.isUndefined(obj.UpstreamProxyUsername)) {\n      $('#UpstreamProxyUsername').val(obj.UpstreamProxyUsername);\n    }\n\n    if (!_.isUndefined(obj.UpstreamProxyPassword)) {\n      $('#UpstreamProxyPassword').val(obj.UpstreamProxyPassword);\n    }\n\n    if (!_.isUndefined(obj.UpstreamProxyDomain)) {\n      $('#UpstreamProxyDomain').val(obj.UpstreamProxyDomain);\n    }\n\n    if (!_.isUndefined(obj.SkipUpstreamProxy)) {\n      $('#SkipUpstreamProxy').prop('checked', obj.SkipUpstreamProxy);\n    }\n    skipUpstreamProxyUpdate();\n\n    upstreamProxyValid(false);\n\n    if (!_.isUndefined(obj.EgressRegion)) {\n      var region = obj.EgressRegion || BEST_REGION_VALUE;\n      $('#EgressRegion [data-region]').removeClass('active');\n      $('#EgressRegion').find('[data-region=\"' + region + '\"] a').trigger(\n        'click',\n        { ignoreDisabled: true });\n    }\n\n    if (!_.isUndefined(obj.SystrayMinimize)) {\n      $('#SystrayMinimize').prop('checked', !!obj.SystrayMinimize);\n    }\n\n    if (!_.isUndefined(obj.DisableDisallowedTrafficAlert)) {\n      $('#DisableDisallowedTrafficAlert').prop('checked', !!obj.DisableDisallowedTrafficAlert);\n    }\n\n    // Re-hook the setting-changed event\n    $('#settings-pane').on(SETTING_CHANGED_EVENT, onSettingChanged);\n  }\n\n  // Extracts the values current set in the tab and returns and object with them.\n  // Returns false if the settings are invalid.\n  function getSettingsTabValues() {\n    var valid = true;\n\n    valid = valid && egressRegionValid(true);\n    valid = valid && localProxyValid(true);\n    valid = valid && upstreamProxyValid(true);\n\n    if (!valid) {\n      return false;\n    }\n\n    var egressRegion = $('#EgressRegion li.active').data('region');\n\n    var returnValue = {\n      VPN: $('#VPN').prop('checked') ? 1 : 0,\n      SplitTunnel: $('#SplitTunnel').prop('checked') ? 1 : 0,\n      DisableTimeouts: $('#DisableTimeouts').prop('checked') ? 1 : 0,\n      LocalHttpProxyPort: validatePort($('#LocalHttpProxyPort').val()),\n      LocalSocksProxyPort: validatePort($('#LocalSocksProxyPort').val()),\n      UpstreamProxyHostname: $('#UpstreamProxyHostname').val(),\n      UpstreamProxyPort: validatePort($('#UpstreamProxyPort').val()),\n      UpstreamProxyUsername: $('#UpstreamProxyUsername').val(),\n      UpstreamProxyPassword: $('#UpstreamProxyPassword').val(),\n      UpstreamProxyDomain: $('#UpstreamProxyDomain').val(),\n      SkipUpstreamProxy: $('#SkipUpstreamProxy').prop('checked') ? 1 : 0,\n      EgressRegion: egressRegion === BEST_REGION_VALUE ? '' : egressRegion,\n      SystrayMinimize: $('#SystrayMinimize').prop('checked') ? 1 : 0,\n      DisableDisallowedTrafficAlert: $('#DisableDisallowedTrafficAlert').prop('checked') ? 1 : 0\n    };\n\n    return returnValue;\n  }\n\n  function showSettingsErrorModal() {\n    showNoticeModal(\n      'settings#error-modal#title',\n      'settings#error-modal#body',\n      null, null,\n      function() {\n        showSettingErrorSection();\n      }\n    );\n  }\n\n  function showSettingErrorSection() {\n    showSettingsSection(\n      $('#settings-accordion .collapse .error').parents('.collapse').eq(0),\n      $('#settings-pane .error input').eq(0).focus());\n  }\n\n  //\n  // Systray Minimize\n  //\n\n  // Will be called exactly once. Set up event listeners, etc.\n  function systrayMinimizeSetup() {\n    $('#SystrayMinimize').change(function() {\n      // Tell the settings pane a change was made.\n      $('#settings-pane').trigger(SETTING_CHANGED_EVENT, this.id);\n    });\n  }\n\n  //\n  // Disable disallowed traffic alert\n  //\n\n  // Will be called exactly once. Set up event listeners, etc.\n  function disableDisallowedTrafficSetup() {\n    $('#DisableDisallowedTrafficAlert').change(function() {\n      // Tell the settings pane a change was made.\n      $('#settings-pane').trigger(SETTING_CHANGED_EVENT, this.id);\n    });\n  }\n\n  //\n  // Split Tunnel\n  //\n\n  // Will be called exactly once. Set up event listeners, etc.\n  function splitTunnelSetup() {\n    $('#SplitTunnel').change(function() {\n      // Tell the settings pane a change was made.\n      $('#settings-pane').trigger(SETTING_CHANGED_EVENT, this.id);\n    });\n  }\n\n  //\n  // Disable Timeouts\n  //\n\n  // Will be called exactly once. Set up event listeners, etc.\n  function disableTimeoutsSetup() {\n    $('#DisableTimeouts').change(function() {\n      // Tell the settings pane a change was made.\n      $('#settings-pane').trigger(SETTING_CHANGED_EVENT, this.id);\n    });\n  }\n\n  //\n  // Egress Region (Psiphon Server Region)\n  //\n\n  // Will be called exactly once. Set up event listeners, etc.\n  function egressRegionSetup() {\n    // Handle changes to the Egress Region\n    $('#EgressRegion a').click(function(e, extraArgs) {\n      e.preventDefault();\n\n      // Do nothing if we're disabled, unless we're forcing a disabled bypass\n      if ($('#EgressRegion').hasClass('disabled') &&\n          (!extraArgs || !extraArgs.ignoreDisabled)) {\n        $(this).blur();\n        return;\n      }\n\n      // Check if this target item is already active. Return if so.\n      if ($(this).parents('[data-region]').hasClass('active')) {\n        return;\n      }\n\n      $('#EgressRegion [data-region]').removeClass('active');\n      $(this).parents('[data-region]').addClass('active');\n      egressRegionValid(false);\n\n      // This event helps the combobox on the connect pane stay in sync.\n      $('#EgressRegion').trigger('change');\n\n      // Tell the settings pane a change was made.\n      $('#settings-pane').trigger(SETTING_CHANGED_EVENT, 'EgressRegion');\n    });\n  }\n\n  // Returns true if the egress region value is valid, otherwise false.\n  // Shows/hides an error message as appropriate.\n  function egressRegionValid(/*finalCheck*/) {\n    var $currRegionElem = $('#EgressRegion li.active');\n\n    // Check to make sure the currently selected egress region is one of the\n    // available regions.\n    var valid = $currRegionElem.length > 0 && !$currRegionElem.hasClass('hidden');\n\n    $('#EgressRegion').toggleClass('error', !valid);\n    $('#settings-accordion-egress-region .egress-region-invalid').toggleClass('hidden', valid);\n\n    updateErrorAlert();\n    return valid;\n  }\n\n  // Check to make sure the currently selected egress region is one of the available\n  // regions. If not, inform the user and get them to pick another.\n  // A mismatch may occur either as a result of a change in the available egress\n  // regions, or a change in the current selection (i.e., a settings change).\n  function forceEgressRegionValid() {\n    if (egressRegionValid()) {\n      // Valid, nothing to do\n      return;\n    }\n\n    // Put up the modal message\n    showNoticeModal(\n      'settings#egress-region#error-modal-title',\n      'settings#egress-region#error-modal-body-http',\n      null, null, null);\n\n    showSettingsSection('#settings-accordion-egress-region');\n  }\n\n  // Update the egress region options we show in the UI.\n  // If `forceValid` is true, then if the currently selected region is no longer\n  // available, the user will be prompted to pick a new one.\n  function updateAvailableEgressRegions(forceValid) {\n    var regions = getCookie('AvailableEgressRegions');\n    // On first run there will be no such cookie.\n    regions = regions || [];\n\n    $('#EgressRegion li').each(function() {\n      var elemRegion = $(this).data('region');\n\n      // If no region, this is a divider\n      if (!elemRegion) {\n        return;\n      }\n\n      if (_.includes(regions, elemRegion) || elemRegion === BEST_REGION_VALUE) {\n        $(this).removeClass('hidden');\n      }\n      else {\n        $(this).addClass('hidden');\n      }\n    });\n\n    if (forceValid) {\n      forceEgressRegionValid();\n    }\n\n    $('#EgressRegion').trigger('change');\n  }\n\n  //\n  // Local Proxy Ports\n  //\n\n  // Will be called exactly once. Set up event listeners, etc.\n  function localProxySetup() {\n    // Handle change events\n    $('#LocalHttpProxyPort, #LocalSocksProxyPort').on(\n        'keyup keydown keypress change blur',\n        function(event) {\n          // We need to delay this processing so that the change to the text has\n          // had a chance to take effect. Otherwise this.val() will return the old\n          // value.\n          _.delay(_.bind(function() {\n            // Tell the settings pane a change was made.\n            $('#settings-pane').trigger(SETTING_CHANGED_EVENT, this.id);\n\n            // Check for validity.\n            localProxyValid(false);\n          }, this, event), 100);\n        });\n  }\n\n  // Returns true if the local proxy values are valid, otherwise false.\n  // Shows/hides an error message as appropriate.\n  function localProxyValid(/*finalCheck*/) {\n    // This check always shows an error while the user is typing, so finalCheck is ignored.\n\n    var httpPort = validatePort($('#LocalHttpProxyPort').val());\n    var socksPort = validatePort($('#LocalSocksProxyPort').val());\n    var unique = (httpPort !== socksPort) || (httpPort === 0) || (socksPort === 0);\n\n    if (httpPort !== false && unique) {\n      // Remove HTTP port error state\n      $('#LocalHttpProxyPort').parents('.control-group').removeClass('error');\n    }\n\n    if (socksPort !== false && unique) {\n      // Remove SOCKS port error state\n      $('#LocalSocksProxyPort').parents('.control-group').removeClass('error');\n    }\n\n    if (httpPort !== false) {\n      // Remove port value error message\n      $('.help-inline.LocalHttpProxyPort').addClass('hidden');\n    }\n\n    if (socksPort !== false) {\n      // Remove port value error message\n      $('.help-inline.LocalSocksProxyPort').addClass('hidden');\n    }\n\n    if (unique) {\n      // Remove uniqueness error message\n      $('.help-block.local-port-unique').addClass('hidden');\n    }\n\n    if (httpPort === false) {\n      // Add HTTP port error state\n      $('#LocalHttpProxyPort').parents('.control-group').addClass('error');\n      $('.help-inline.LocalHttpProxyPort').removeClass('hidden');\n    }\n\n    if (socksPort === false) {\n      // Add SOCKS port error state\n      $('#LocalSocksProxyPort').parents('.control-group').addClass('error');\n      $('.help-inline.LocalSocksProxyPort').removeClass('hidden');\n    }\n\n    if (!unique) {\n      // Add error state on both ports\n      $('#LocalHttpProxyPort, #LocalSocksProxyPort')\n        .parents('.control-group').addClass('error');\n      // Show error message\n      $('.help-block.local-port-unique').removeClass('hidden');\n    }\n\n    updateErrorAlert();\n\n    return httpPort !== false && socksPort !== false && unique;\n  }\n\n  // Show an error modal telling the user there is a local port conflict problem\n  function localProxyPortConflictNotice(noticeType) {\n    // Show the appropriate message depending on the error\n    var bodyKey = noticeType === 'HttpProxyPortInUse' ?\n                  'settings#local-proxy-ports#error-modal-body-http' :\n                  'settings#local-proxy-ports#error-modal-body-socks';\n\n    showNoticeModal(\n      'settings#local-proxy-ports#error-modal-title',\n      bodyKey,\n      null, null, null);\n\n    // Switch to the appropriate settings section\n    showSettingsSection(\n      '#settings-accordion-local-proxy-ports',\n      noticeType === 'HttpProxyPortInUse' ? '#LocalHttpProxyPort' : '#LocalSocksProxyPort');\n  }\n\n  //\n  // Upstream Proxy\n  //\n\n  // Will be called exactly once. Set up event listeners, etc.\n  function upstreamProxySetup() {\n    // Handle change events\n    $('#UpstreamProxyHostname, #UpstreamProxyPort, #UpstreamProxyUsername, #UpstreamProxyPassword, #UpstreamProxyDomain').on(\n        'keyup keydown keypress change blur',\n        function(event) {\n          // We need to delay this processing so that the change to the text has\n          // had a chance to take effect. Otherwise this.val() will return the old\n          // value.\n          _.delay(_.bind(function() {\n            // Tell the settings pane a change was made.\n            $('#settings-pane').trigger(SETTING_CHANGED_EVENT, this.id);\n\n            // Check for validity.\n            upstreamProxyValid(false);\n          }, this, event), 100);\n        });\n\n    // Add the \"skip\" checkbox handler.\n    $('#SkipUpstreamProxy').change(function() {\n      // Trigger overall change event\n      $('#settings-pane').trigger(SETTING_CHANGED_EVENT, this.id);\n\n      skipUpstreamProxyUpdate();\n    });\n  }\n\n  // Returns true if the upstream proxy values are valid, otherwise false.\n  // Shows/hides an error message as appropriate.\n  function upstreamProxyValid(/*finalCheck*/) {\n    // If any field other than hostname is set, then hostname must be set,\n    // AND if port is set, it must be an integer in the range 1-65535,\n    // AND if either of domain or password is set, then username must be as well.\n    // Unless 'skip' is checked.\n\n    let skip = $('#SkipUpstreamProxy').prop('checked');\n\n    let needHostname =\n      Boolean($('#UpstreamProxyPort').val()) ||\n      Boolean($('#UpstreamProxyUsername').val()) ||\n      Boolean($('#UpstreamProxyPassword').val()) ||\n      Boolean($('#UpstreamProxyDomain').val());\n\n    let needUsername =\n      Boolean($('#UpstreamProxyPassword').val()) ||\n      Boolean($('#UpstreamProxyDomain').val());\n\n    let valid = true;\n\n    let portOK = validatePort($('#UpstreamProxyPort').val()) !== false;\n    if (skip || portOK) {\n      // Hide the port-specific message\n      $('.help-inline.UpstreamProxyPort').addClass('hidden')\n        .parents('.control-group').removeClass('error');\n    } else {\n      valid = false;\n      // Port value bad. Show error while typing\n      $('.help-inline.UpstreamProxyPort').removeClass('hidden')\n        .parents('.control-group').addClass('error');\n    }\n\n    if (skip || !needHostname || Boolean($('#UpstreamProxyHostname').val())) {\n      // Hide the \"hostname required\" message\n      $('.upstream-proxy-set-hostname-error-msg').addClass('hidden');\n      // And remove error state from the control\n      $('#UpstreamProxyHostname')\n        .parents('.control-group').removeClass('error');\n    }\n    else {\n      valid = false;\n      // Show the \"hostname required\" message\n      $('.upstream-proxy-set-hostname-error-msg').removeClass('hidden');\n      // And add error state to the control\n      $('#UpstreamProxyHostname')\n        .parents('.control-group').addClass('error');\n    }\n\n    if (skip || !needUsername || Boolean($('#UpstreamProxyUsername').val())) {\n      // Hide the \"username required\" message\n      $('.upstream-proxy-set-username-error-msg').addClass('hidden');\n      // And remove error state from the control\n      $('#UpstreamProxyUsername')\n        .parents('.control-group').removeClass('error');\n    }\n    else {\n      valid = false;\n      // Show the \"username required\" message\n      $('.upstream-proxy-set-username-error-msg').removeClass('hidden');\n      // And add error state to the control\n      $('#UpstreamProxyUsername')\n        .parents('.control-group').addClass('error');\n    }\n\n    updateErrorAlert();\n\n    return valid;\n  }\n\n  // The other upstream proxy settings should be disabled if skip-upstream-proxy\n  // is set.\n  function skipUpstreamProxyUpdate() {\n    var skipUpstreamProxy = $('#SkipUpstreamProxy').prop('checked');\n    $('.skip-upstream-proxy-incompatible input').prop('disabled', skipUpstreamProxy);\n    $('.skip-upstream-proxy-incompatible').toggleClass('disabled-text', skipUpstreamProxy);\n  }\n\n  // The occurrence of an upstream proxy error might mean that a tunnel cannot\n  // ever be established, but not necessarily -- it might just be, for example,\n  // that the upstream proxy doesn't allow the port needed for one of our\n  // servers, but not all of them.\n  // So instead of showing an error immediately, we'll remember that the upstream\n  // proxy error occurred, wait a while to see if we connect successfully, and\n  // show it if we haven't connected.\n  // Potential enhancement: If the error modal is showing and the connection\n  // succeeds, dismiss the modal. This would be good behaviour, but probably too\n  // fringe to be worthwhile.\n  var g_upstreamProxyErrorNoticeTimer = null;\n\n  // When the connected state changes, we clear the timer.\n  $window.on(CONNECTED_STATE_CHANGE_EVENT, function() {\n    if (g_upstreamProxyErrorNoticeTimer) {\n      clearTimeout(g_upstreamProxyErrorNoticeTimer);\n      g_upstreamProxyErrorNoticeTimer = null;\n    }\n  });\n\n  function upstreamProxyErrorNotice(errorMessage) {\n    if (g_upstreamProxyErrorNoticeTimer) {\n      // We've already received an upstream proxy error and we're waiting to show it.\n      return;\n    }\n\n    // This is the first upstream proxy error we've received, so start waiting to\n    // show a message for it.\n    g_upstreamProxyErrorNoticeTimer = setTimeout(function() {\n      // It can happen that we receive a notice about an upstream error *after*\n      // we have successfully connected -- it will have been received from one\n      // of the parallel unsuccessful connection attempts. We should not show\n      // such an error. So, as a general statement: Do not show upstream errors\n      // if we're already successfully connected.\n      if (g_lastState === 'connected') {\n        if (g_upstreamProxyErrorNoticeTimer) {\n          g_upstreamProxyErrorNoticeTimer = null;\n        }\n        return;\n      }\n\n      // There are two slightly different error messages shown depending on whether\n      // there is an upstream proxy explicitly configured, or it's the default\n      // empty value, which means the pre-existing system proxy will be used.\n      var bodyKey = 'settings#upstream-proxy#error-modal-body-default';\n      if (g_initObj.Settings.UpstreamProxyHostname) {\n        bodyKey = 'settings#upstream-proxy#error-modal-body-configured';\n      }\n\n      showNoticeModal(\n        'settings#upstream-proxy#error-modal-title',\n        bodyKey,\n        'general#notice-modal-tech-preamble',\n        errorMessage,\n        function() {\n          $('#UpstreamProxyHostname').focus();\n        });\n\n      // Switch to the appropriate settings section\n      showSettingsSection('#settings-accordion-upstream-proxy');\n\n      // We are not going to set the timer to null here. We only want the error\n      // to show once per connection attempt sequence. It will be cleared when\n      // the client transistions to 'stopped' or 'connected'.\n    }, 60000);\n  }\n\n  //\n  // VPN Mode (Transport Mode)\n  //\n\n  // Will be called exactly once. Set up event listeners, etc.\n  function vpnModeSetup() {\n    // Some fields are disabled in VPN mode\n    $('#VPN').change(function() {\n      // Tell the settings pane a change was made.\n      $('#settings-pane').trigger(SETTING_CHANGED_EVENT, this.id);\n\n      vpnModeUpdate();\n    });\n  }\n\n  // Some of the settings are incompatible with VPN mode. We'll modify the\n  // display depending on the choice of VPN mode.\n  function vpnModeUpdate() {\n    var vpn = $('#VPN').prop('checked');\n    $('input.vpn-incompatible, .vpn-incompatible input, '+\n      'select.vpn-incompatible, .vpn-incompatible select, .vpn-incompatible .dropdown-menu')\n        .prop('disabled', vpn).toggleClass('disabled', vpn);\n    $('.vpn-incompatible-msg').toggleClass('hidden', !vpn);\n    $('.vpn-incompatible').toggleClass('disabled-text', vpn);\n    $('.vpn-incompatible-hide').toggleClass('hidden', vpn);\n  }\n\n  //\n  // Helpers\n  //\n\n  // Show/hide the error alert depending on whether we have an erroneous field\n  function updateErrorAlert() {\n    $('#settings-pane .value-error-alert').toggleClass(\n      'invisible z-behind', $('#settings-pane .control-group.error').length === 0);\n  }\n\n  // Returns the numeric port if valid, otherwise false. Note that 0 is a valid\n  // return value, and falsy, so use `=== false`.\n  function validatePort(val) {\n    if (val.length === 0) {\n      return 0;\n    }\n\n    const intVal = parseInt(val);\n    if (isNaN(intVal) || intVal < 1 || intVal > 65535) {\n      return false;\n    }\n\n    if (intVal.toString() !== val) {\n      // There were extra characters at the end of the string that didn't get converted\n      // into the int.\n      return false;\n    }\n\n    return intVal;\n  }\n\n  // Show the Settings tab and expand the target section.\n  // If focusElem is optional; if set, focus will be put in that element.\n  function showSettingsSection(section, focusElem) {\n    // We can only expand the section after the tab is shown\n    function onTabShown() {\n      // Hack: The collapse-show doesn't seem to work unless we wait a bit\n      setTimeout(function() {\n        // Expand the section\n        $(section).collapse('show');\n\n        // Collapse any other sections\n        $('#settings-accordion .in.collapse').not(section).collapse('hide');\n\n        // Scroll to the section, after allowing the section to expand\n        setTimeout(function() {\n          $('#settings-pane').scrollTo(\n            $(section).parents('.accordion-group').eq(0),\n            {\n              duration: 500, // animation time\n              offset: -50,   // leave some space for the alert\n              onAfter: function() {\n                if (focusElem) {\n                  $(focusElem).eq(0).focus();\n                }\n              }\n            });\n        }, 200);\n      }, 500);\n    }\n\n    // Make sure the settings tab is showing.\n    switchToTab('#settings-tab', onTabShown);\n  }\n\n\n  /* FEEDBACK ******************************************************************/\n\n  $(function() {\n    // Add click listener to the happy/sad choices\n    $('.feedback-smiley .feedback-choice').click(function(e) {\n      e.preventDefault();\n      $('.feedback-smiley .feedback-choice').removeClass('selected');\n      $(this).addClass('selected');\n    });\n\n    $('#feedback-submit').click(function(e) {\n      e.preventDefault();\n      sendFeedback();\n    });\n\n    // The sponsor-specific links in the text will be set correctly elsewhere.\n  });\n\n  function sendFeedback() {\n    var smileyResponses = [];\n    $('.feedback-choice.selected').each(function() {\n      smileyResponses.push({\n        title: $(this).data('feedback-choice-title'),\n        question: $(this).data('feedback-choice-hash'),\n        answer: $(this).data('feedback-choice-value')\n      });\n    });\n\n    var fields = {\n      responses: smileyResponses,\n      feedback: $('#feedback-comments').val(),\n      email: $('#feedback-email').val(),\n      sendDiagnosticInfo: !!$('#feedback-send-diagnostic').prop('checked')\n    };\n\n    // Switch to the connection tab\n    switchToTab('#connection-tab');\n\n    // Clear the feedback form\n    $('.feedback-choice.selected').removeClass('selected');\n    $('#feedback-comments').val('');\n    $('#feedback-email').val('');\n    $('#feedback-send-diagnostic').prop('checked', true);\n\n    // Actually send the feedback\n    HtmlCtrlInterface_SendFeedback(JSON.stringify(fields));\n\n    // Show (and hide) the success alert\n    displayCornerAlert($('#feedback-success-alert'));\n  }\n\n\n  /* LOGS **********************************************************************/\n\n  $(function() {\n    $('#show-debug-logs').click(showDebugLogsClicked);\n\n    // Set the initial show-debug state\n    var show = $('#show-debug-logs').prop('checked');\n    $('.log-messages')\n      .toggleClass('showing-priority-0', show)\n      .toggleClass('hiding-priority-0', !show);\n  });\n\n  function showDebugLogsClicked() {\n    /*jshint validthis:true */\n    var show = $(this).prop('checked');\n    // We use both a showing and a hiding class to try to deal with IE7's CSS insanity.\n    $('.log-messages')\n      .toggleClass('showing-priority-0', show)\n      .toggleClass('hiding-priority-0', !show);\n  }\n\n  // Expects obj to be of the form {priority: 0|1|2, message: string}\n  function addLog(obj) {\n    $('.log-messages .placeholder').remove();\n\n    $('.log-messages').loadTemplate(\n      $(\"#log-template\"),\n      {\n        timestamp: new Date().toLocaleTimeString(),\n        message: obj.message,\n        priority: 'priority-' + obj.priority\n      },\n      {\n        prepend:true\n      });\n\n    // The \"Show Debug Logs\" checkbox is hidden until we actually get a debug\n    // message.\n    if (obj.priority < 1) {\n      $('#logs-pane .invisible').removeClass('invisible');\n    }\n\n    // Record the priorities we've seen.\n    // We'll keep them in a (fake) Set.\n    addLog.priorities = addLog.priorities || {};\n    addLog.priorities[obj.priority] = true;\n\n    // Don't allow the log messages list to grow forever!\n    // We'll set a limit for each priority. (Arbitrarily. May need to revisit.)\n    var MAX_LOGS_PER_PRIORITY = 200;\n    var priorities = _.keys(addLog.priorities);\n    for (var i = 0; i < priorities.length; i++) {\n      $('.log-messages .priority-'+priorities[i]).slice(MAX_LOGS_PER_PRIORITY).remove();\n    }\n  }\n\n  // Used for temporary debugging messages.\n  function DEBUG_LOG() {\n    debugLogHelper(window.console.log, Array.prototype.slice.call(arguments))\n  }\n\n  function DEBUG_WARN() {\n    debugLogHelper(window.console.warn, Array.prototype.slice.call(arguments))\n  }\n\n  function debugLogHelper(consoleLogger, args) {\n    if (!g_initObj.Config.Debug) {\n      return;\n    }\n\n    let msg = 'DEBUG:';\n    for (let i = 0; i < args.length; i++) {\n      msg += ' ';\n      if (_.isString(args[i])) {\n        msg += args[i];\n      }\n      else {\n        msg += JSON.stringify(args[i]);\n      }\n    }\n\n    addLog({priority: 0, message: msg});\n\n    const logger = (consoleLogger || window.console.log);\n    try {\n      if (IS_BROWSER) {\n        logger.apply(console, [msg]);\n      }\n    }\n    catch (e) {\n      // IE8 (at least IE8 mode in IE11) has weird console.log (etc.) implementations that\n      // are objects? But can still be called? But even trying to access .apply throws an\n      // exception? But calling it directly is okay?\n      logger(msg);\n    }\n  }\n\n\n  /* LANGUAGE ******************************************************************/\n\n  var RTL_LOCALES = ['devrtl', 'fa', 'fa_AF', 'ar', 'ur'];\n\n  $(function() {\n    var fallbackLanguage = 'en';\n\n    // Language priority: cookie, system locale, fallback\n    var lang = getCookie('language') ||\n                (g_initObj.Config && g_initObj.Config.Language) ||\n                fallbackLanguage;\n\n    i18n.init(\n      {\n        lang: lang,\n        fallbackLng: fallbackLanguage,\n        resStore: window.PSIPHON.LOCALES\n      },\n      function() {\n        switchLocale(lang, true);\n      });\n\n    // Populate the list of language choices\n    populateLocales();\n  });\n\n  // We only want to show the success/welcome message once.\n  var g_languageSuccessAlertShown = false;\n\n  // Other functions may need to know if we're currently using a RTL locale or not\n  var g_isRTL = false;\n\n  function switchLocale(locale, initial) {\n    i18n.setLng(locale, function() {\n      // This callback does not seem to called asynchronously (probably because\n      // we're loading from an object and not a remote resource). But we want this\n      // code to run after everything else is done, so we'll force it to be async.\n\n      nextTick(function() {\n        // HTML+JS use locale codes of the form 'en-US', rather than\n        // Psiphon's 'en_US'.\n        $('html').attr('lang', locale.replace('_', '-'));\n        $('body').i18n();\n\n        // The content of elements will have changed, so trigger custom event that can\n        // be listened for to take additional actions.\n        $window.trigger(LANGUAGE_CHANGE_EVENT);\n\n        if (!initial && !g_languageSuccessAlertShown) {\n          // Show (and hide) the success alert\n          g_languageSuccessAlertShown = true;\n          displayCornerAlert($('#language-success-alert'));\n        }\n\n        // Remember the user's choice\n        setCookie('language', locale);\n      });\n    });\n\n    //\n    // Right-to-left languages need special consideration.\n    //\n\n    var rtl = _.contains(RTL_LOCALES, locale);\n    g_isRTL = rtl;\n\n    $('body').attr('dir', rtl ? 'rtl' : 'ltr')\n             .css('direction', rtl ? 'rtl' : 'ltr');\n\n    // We'll use a data attribute to store classes which should only be used\n    // for RTL and not LTR, and vice-versa.\n    $('[data-i18n-rtl-classes]').each(function() {\n      var ltrClasses = $(this).data('i18n-ltr-classes');\n      var rtlClasses = $(this).data('i18n-rtl-classes');\n\n      if (ltrClasses) {\n        $(this).toggleClass(ltrClasses, !rtl);\n      }\n\n      if (rtlClasses) {\n        $(this).toggleClass(rtlClasses, rtl);\n      }\n    });\n\n    //\n    // Update C code string table with new language values\n    //\n\n    // Iterate through the English keys, since we know it will be complete.\n    var translation = window.PSIPHON.LOCALES.en.translation;\n    var appBackendStringTable = {};\n    for (var key in translation) {\n      if (!translation.hasOwnProperty(key)) {\n        continue;\n      }\n\n      if (_.startsWith(key, 'appbackend#')) {\n        appBackendStringTable[key] = i18n.t(key);\n      }\n    }\n\n    HtmlCtrlInterface_AddStringTableItem(locale, appBackendStringTable);\n  }\n\n  function populateLocales() {\n    var localePriorityGuide = ['en', 'fa', 'ar', 'zh', 'zh_CN', 'zh_TW'];\n    var locales = $.map(window.PSIPHON.LOCALES, function(val, key) { return key; });\n    // Sort the locales according to the priority guide\n    locales.sort(function(a, b) {\n      var localePriority_a = localePriorityGuide.indexOf(a);\n      var localePriority_b = localePriorityGuide.indexOf(b);\n      localePriority_a = (localePriority_a < 0) ? 999 : localePriority_a;\n      localePriority_b = (localePriority_b < 0) ? 999 : localePriority_b;\n\n      if (localePriority_a < localePriority_b) {\n        return -1;\n      }\n      else if (localePriority_a > localePriority_b) {\n        return 1;\n      }\n      else if (a < b) {\n        return -1;\n      }\n      else if (a > b) {\n        return 1;\n      }\n      return 0;\n    });\n\n    var $localeListElem = $('#language-pane');\n\n    for (var i = 0; i < locales.length; i++) {\n      // If we're not in debug mode, don't output the dev locales\n      if (!g_initObj.Config.Debug && _.startsWith(locales[i], 'dev')) {\n        continue;\n      }\n\n      $localeListElem.loadTemplate(\n        $(\"#locale-template\"),\n        { localeCode: locales[i],\n          localeName: window.PSIPHON.LOCALES[locales[i]].name},\n        { append: true });\n    }\n\n    // Set up the click handlers\n    $('.language-choice').click(function(e) {\n      e.preventDefault();\n      switchLocale($(this).attr('value'));\n    });\n  }\n\n\n  /* ABOUT *********************************************************************/\n\n  // No special code. Sponsor-specific links are set elsewhere.\n\n\n  /* PSICASH *******************************************************************/\n\n  /**\n   * PsiCash-related events.\n   * @enum {string}\n   * @readonly\n   */\n  const PsiCashEventTypeEnum = {\n    /** Argument is PsiCashRefreshData */\n    REFRESH: 'psicash::refresh',\n    /** Argument is PsiCashPurchaseResponse */\n    NEW_PURCHASE: 'psicash::new-purchase',\n    /** Argument is PsiCashInitDoneData */\n    INIT_DONE: 'psicash::init-done'\n  };\n\n  /**\n   * Server response statuses\n   * @enum {number}\n   * @readonly\n   */\n  const PsiCashServerResponseStatus = {\n    Invalid: -1, // Should never be used if well-behaved\n    Success: 0,\n    ExistingTransaction: 1,\n    InsufficientBalance: 2,\n    TransactionAmountMismatch: 3,\n    TransactionTypeNotFound: 4,\n    InvalidTokens: 5,\n    ServerError: 6\n  };\n\n  /**\n   * @typedef {Object} PsiCashPurchasePrice\n   * @property {!string} class\n   * @property {!string} distinguisher\n   * @property {!number} price\n   */\n\n   /**\n    * @typedef {Object} PsiCashPurchase\n    * @property {!string} id\n    * @property {!string} class\n    * @property {!string} distinguisher\n    * @property {?moment} localTimeExpiry;\n    * @property {?moment} serverTimeExpiry;\n    */\n\n  /**\n   * The expected payload passed to HtmlCtrlInterface_PsiCashMessage when a purchase is complete.\n   * @typedef {Object} PsiCashPurchaseResponse\n   * @property {?string} error\n   * @property {!PsiCashServerResponseStatus} status\n   * @property {?PsiCashRefreshData} refresh\n   */\n\n  /**\n   * The expected payload passed to HtmlCtrlInterface_PsiCashMessage when a refresh should be done.\n   * @typedef {Object} PsiCashRefreshData\n   * @property {string[]} valid_token_types\n   * @property {number} balance\n   * @property {PsiCashPurchasePrice[]} purchase_prices\n   * @property {PsiCashPurchase[]} purchases\n   * @property {string} buy_psi_url\n   */\n\n  /**\n   * The expected payload passed to HtmlCtrlInterface_PsiCashMessage when PsiCash.Init() is done.\n   * @typedef {Object} PsiCashInitDoneData\n   * @property {?string} error\n   * @property {?boolean} recovered\n   */\n\n   /**\n   * Used as the \"command\" type passed to HtmlCtrlInterface_PsiCashCommand.\n   * @enum {string}\n   * @readonly\n   */\n  const PsiCashCommandEnum = {\n    REFRESH: 'refresh',\n    PURCHASE: 'purchase'\n  }\n\n  /**\n   * PsiCash command base class constrcutor\n   * @class PsiCashCommandBase\n   * @classdesc Should only be used by subclasses\n   * @param {PsiCashCommandEnum} command\n   */\n  function PsiCashCommandBase(command) {\n    /**\n     * @name PsiCashCommandBase#command\n     * @type {PsiCashCommandEnum}\n     */\n    this.command = command;\n\n    /**\n     * @name PsiCashCommandBase#id\n     * @type {string}\n     */\n    this.id = randomID();\n  }\n\n  /**\n   * Construct a new refresh command\n   * @class PsiCashCommandRefresh\n   * @classdesc Passed to HtmlCtrlInterface_PsiCashCommand to indicate a data refresh is desired\n   * @param {string} reason Indicates the reason for the refresh (used for logging and debugging)\n   */\n  function PsiCashCommandRefresh(reason) {\n    PsiCashCommandBase.call(this, PsiCashCommandEnum.REFRESH);\n    this.reason = reason;\n  }\n  PsiCashCommandRefresh.prototype = _.create(PsiCashCommandBase.prototype, {constructor: PsiCashCommandRefresh});\n\n  /**\n   * Construct a new purchase command\n   * @class PsiCashCommandPurchase\n   * @classdesc Passed to HtmlCtrlInterface_PsiCashCommand to indicate a purchase is desired\n   * @param {string} transactionClass\n   * @param {string} distinguisher\n   * @param {number} expectedPrice\n   */\n  function PsiCashCommandPurchase(transactionClass, distinguisher, expectedPrice) {\n    PsiCashCommandBase.call(this, PsiCashCommandEnum.PURCHASE);\n    this.transactionClass = transactionClass;\n    this.distinguisher = distinguisher;\n    this.expectedPrice = expectedPrice;\n  }\n  PsiCashCommandPurchase.prototype = _.create(PsiCashCommandBase.prototype, {constructor: PsiCashCommandPurchase});\n\n  /**\n   * PsiCash-related messages from the C code.\n   * @enum {string}\n   * @readonly\n   */\n  const PsiCashMessageTypeEnum = {\n    REFRESH: 'refresh',\n    NEW_PURCHASE: 'new-purchase',\n    INIT_DONE: 'init-done'\n  };\n\n  /**\n   * @typedef {Object} PsiCashMessageData\n   * @property {PsiCashMessageTypeEnum} type\n   * @property {string} id\n   * @property {PsiCashRefreshData} payload\n   */\n\n  // TODO: Maybe roll this into a more global pubsub? But why?\n  /** @type {Datastore} */\n  const PsiCashStore = new Datastore({\n    initDone: false,\n    purchaseInProgress: false\n  }, 'PsiCashStore');\n\n  $(function psicashInit() {\n    // NOTE: \"refresh\" will not make a server request unless we're connected. If not\n    // connected, it just gets locally cached values.\n\n    // And update the UI values every time the app gets focus.\n    addWindowFocusHandler(function() {\n      if (!PsiCashStore.data.initDone) {\n        return;\n      }\n      HtmlCtrlInterface_PsiCashCommand(new PsiCashCommandRefresh('app-focus'));\n    });\n\n    // And update the UI values every time we get connected.\n    $window.on(CONNECTED_STATE_CHANGE_EVENT, function() {\n      if (!PsiCashStore.data.initDone) {\n        return;\n      }\n      HtmlCtrlInterface_PsiCashCommand(new PsiCashCommandRefresh('connected-state-change'));\n    });\n\n    // And update the UI values every time the display language changes, so that the numbers\n    // are correctly formatted.\n    $window.on(LANGUAGE_CHANGE_EVENT, function() {\n      if (!PsiCashStore.data.initDone) {\n        return;\n      }\n      HtmlCtrlInterface_PsiCashCommand(new PsiCashCommandRefresh('ui-language-change'));\n    });\n\n    // And update the UI when the settings change. If we go into/out of VPN mode we need to\n    // disable the UI and indicate why.\n    $('#settings-pane').on(SETTING_CHANGED_EVENT, function() {\n      if (!PsiCashStore.data.initDone) {\n        return;\n      }\n      HtmlCtrlInterface_PsiCashCommand(new PsiCashCommandRefresh('settings-changed'));\n    });\n  });\n\n  /**\n   * Handles the message indicating that the PsiCash library failed to initialize.\n   * @param {*} evt Event. Unused.\n   * @param {PsiCashInitDoneData} data\n   */\n  function psiCashLibraryInitDone(evt, data) {\n    if (data.error) {\n      // The library failed to initialize. This is very bad. The user lost their Tracker credit\n      // or their Account logged-in state.\n      if (data.recovered) {\n        showNoticeModal(\n          'psicash#init-error-title',\n          'psicash#init-error-body-recovered',\n          'general#notice-modal-tech-preamble',\n          data.error,\n          null); // callback\n      }\n      else {\n        showNoticeModal(\n          'psicash#init-error-title',\n          'psicash#init-error-body-unrecovered',\n          'general#notice-modal-tech-preamble',\n          data.error,\n          null); // callback\n      }\n    }\n\n    PsiCashStore.set('initDone', true);\n    HtmlCtrlInterface_PsiCashCommand(new PsiCashCommandRefresh('init-done'));\n  }\n  $window.on(PsiCashEventTypeEnum.INIT_DONE, psiCashLibraryInitDone);\n\n  /**\n   * Helper function to determine if PsiCash is ready for use.\n   * @param {?PsiCashRefreshData} psicashData The data to use for the check. If not provided,\n   *    g_PsiCashData will be used.\n   */\n  function psiCashStateInitialized(psicashData) {\n    if (psicashData) {\n      g_PsiCashData = psicashData;\n    }\n\n    return psicashData.valid_token_types && psicashData.valid_token_types.length > 0\n      && _.isNumber(psicashData.balance) && !_.isNaN(psicashData.balance);\n  }\n\n  var PSICASH_ENABLED_COOKIE = 'psicash::Enabled';\n\n  /**\n   * Called when PsiCash-related data should be refreshed. This may or may not mean that\n   * a request was made to the server to get fresh data.\n   * @param {PsiCashRefreshData} data\n   */\n  function refreshPsiCashEventHandler(evt, data) {\n    psiCashUIUpdater(data);\n  }\n  $window.on(PsiCashEventTypeEnum.REFRESH, refreshPsiCashEventHandler);\n\n  /** @type {?PsiCashRefreshData} */\n  var g_PsiCashData = null;\n\n  /**\n   * The state determines which chunks of UI are visible.\n   * @enum {object}\n   * @readonly\n   */\n  const PsiCashUIState = {\n    ZERO_BALANCE: {uiSelector: '#psicash-interface-zerobalance'},\n    NSF_BALANCE: {uiSelector: '#psicash-interface-nsfbalance'},\n    ENOUGH_BALANCE: {uiSelector: '#psicash-interface-enoughbalance'},\n    BUYING_BOOST: {uiSelector: '#psicash-interface-buyingboost'},\n    ACTIVE_BOOST: {uiSelector: '#psicash-interface-activeboost'},\n    VPN_MODE_DISABLED: {uiSelector: '#psicash-interface-vpndisabled'}\n  };\n  PsiCashStore.set('uiState', PsiCashUIState.ZERO_BALANCE);\n\n  /**\n   * Called from refreshPsiCash and on an interval to update the PsiCash UI.\n   * @param {?PsiCashRefreshData} psicashData Will be undefined when called on a timer.\n   */\n  function psiCashUIUpdater(psicashData) {\n    // This must be set by any code below that queues up another call to this function via\n    // setTimeout. This is to prevent building up a flood of redundant calls.\n    if (!psiCashUIUpdater.timeout) {\n      psiCashUIUpdater.timeout = null;\n    }\n\n    if (psicashData) {\n      if (g_PsiCashData) {\n        // For later diagnostics, log if psicashData values changed\n        if (!_.isNaN(psicashData.balance) && psicashData.balance !== g_PsiCashData.balance) {\n          HtmlCtrlInterface_Log('PsiCash: balance change:', psicashData.balance - g_PsiCashData.balance);\n        }\n        // TODO: Log other changes? Kind of a hassle.\n      }\n\n      g_PsiCashData = psicashData;\n    }\n    else if (!g_PsiCashData) {\n      // No data to use, nothing to do.\n      return;\n    }\n\n    psicashData = g_PsiCashData;\n\n    /**\n     * Will be true for the very first update when the UI is enabled. Affects which animations are shown.\n     */\n    let veryFirstUpdate = false;\n\n    // The enabled cookie will not be present on the very first run, and is set to true\n    // when we first enter a state where the PsiCash UI can be shown (and the onboarding\n    // presented).\n    if (getCookie(PSICASH_ENABLED_COOKIE)) {\n      // Even if the cookie is present, the user might have deleted their psicashdatastore\n      // file, so double-check the sanity of our state.\n      if (!psiCashStateInitialized(psicashData)) {\n        setCookie(PSICASH_ENABLED_COOKIE, false);\n        // Re-call this function to start all over.\n        return psiCashUIUpdater(psicashData);\n      }\n    }\n    else {\n      // Check if we're in a state where the functionality can be enabled.\n      if (windowHasFocus()\n          && psiCashStateInitialized(psicashData)\n          && g_lastState === 'connected')\n      {\n        // We're in a good state, and this is the very first time.\n        HtmlCtrlInterface_Log('PsiCash: very first update');\n        veryFirstUpdate = true;\n        setCookie(PSICASH_ENABLED_COOKIE, true);\n        // TODO: onboarding\n      }\n      else {\n        // PsiCash is still disabled, so there's nothing to do.\n        return;\n      }\n    }\n\n    if ($('#psicash-block').hasClass('hidden')) {\n      $('#psicash-block').removeClass('hidden');\n\n      // Some layout actions like height-matching won't have succeeded while the\n      // UI was hidden. So do a content-resize with the newly visible content.\n      nextTick(resizeContent);\n    }\n\n    if (psicashData.buy_psi_url) {\n      const urlComp = urlComponents(psicashData.buy_psi_url);\n      urlComp.search +=  (urlComp.search ? '&' : '?') + 'utm_source=windows_app';\n      $('a.psicash-buy-psi').prop('href', urlComp.href).removeClass('hidden');\n    }\n    else {\n      // For some states (like zero balance), hiding the \"buy\" button will look strange, but\n      // since that implies there's no earner token, the whole PsiCash UI will be hidden anyway.\n      $('a.psicash-buy-psi').addClass('hidden');\n    }\n\n    let sbPrices = {};\n    if (psicashData.purchase_prices) {\n      // NOTE: This does not handle disappearing prices.\n      for (let i = 0; i < psicashData.purchase_prices.length; i++) {\n        let pp = psicashData.purchase_prices[i];\n\n        if (pp['class'] === 'speed-boost') {\n          sbPrices[pp.distinguisher] = pp.price;\n\n          $(`.psicash-sb-price[data-distinguisher=\"${pp.distinguisher}\"]`).text(formatPsi(parseInt(pp.price)));\n          $(`.psicash-sb-price[data-distinguisher=\"${pp.distinguisher}\"]`).data('expectedPrice', pp.price);\n        }\n      }\n    }\n\n    let state = PsiCashUIState.ZERO_BALANCE;\n    // DO NOT return early from this point. state must be updated in PsiCashStore.uiState.\n\n    // Only the 1-hour Speed Boost is considered for determining if the user has \"enough\" Psi\n    if (_.isNumber(psicashData.balance) && _.isNumber(sbPrices['1hr'])) {\n      if (psicashData.balance >= sbPrices['1hr']) {\n        state = PsiCashUIState.ENOUGH_BALANCE;\n\n        // Enable/disable the 1-day button depending on balance.\n        // (Note that this is only a cosmetic disabling, and the button will still respond\n        // to clicks. It will show an appropriate NSF message.)\n        const nsf1Day = (psicashData.balance < sbPrices['24hr']);\n        $('.psicash-buy[data-distinguisher=\"24hr\"]').prop('disabled', nsf1Day).toggleClass('disabled', nsf1Day)\n      }\n      else if (psicashData.balance > 0) {\n        state = PsiCashUIState.NSF_BALANCE;\n      }\n    }\n\n    let millisOfSpeedBoostRemaining = 0;\n\n    if (psicashData.purchases) {\n      for (let i = 0; i < psicashData.purchases.length; i++) {\n        // There are two different contexts/ways of checking for active Speed Boost.\n        // **If we are connected**, then we rely on psiphond to decide that the\n        // authorization is expired, which will result in tunnel-core reconnecting and a\n        // signal that the authorization is now rejected. This is when the purchase is\n        // actually removed from the PsiCash lib datastore. So, if we are connected, its\n        // presence in the purchases array should be interpreted as meaning that the\n        // purchase/authorization is valid.\n        // **If we are not connected**, then we have to rely on the purchase expiry.\n        // (We're certainly not going to show a purchase as active for hours too long\n        // until the user happens to connect and refresh PsiCash state.)\n        // Note: We're making no special effort to check for multiple active Speed Boosts.\n        // This should not happen, per server rules.\n\n        if (psicashData.purchases[i]['class'] === 'speed-boost') {\n          const localTimeExpiry = moment(psicashData.purchases[i].localTimeExpiry);\n          if (g_lastState === 'connected' || localTimeExpiry.isAfter(moment())) {\n            state = PsiCashUIState.ACTIVE_BOOST;\n\n            millisOfSpeedBoostRemaining = localTimeExpiry.diff(moment());\n            // Clock skew (between client<->PsiCash server<->psiphond) could result in a\n            // purchase being used past the expiry in the purchase record. Ensure we're\n            // not showing a negative value in the UI.\n            millisOfSpeedBoostRemaining = Math.max(0, millisOfSpeedBoostRemaining);\n\n            const boostRemainingTime = moment\n                .duration(millisOfSpeedBoostRemaining)\n                .locale(momentLocale())\n                .humanize()\n                .replace(' ', '&nbsp;'); // avoid splitting the time portion\n            const boostRemainingText = i18n.t('psicash#ui-speedboost-active').replace('%s', boostRemainingTime);\n            $('.speed-boost-time-remaining').html(boostRemainingText);\n            break;\n          }\n        }\n      }\n    }\n\n    if (PsiCashStore.data.purchaseInProgress) {\n      // We are waiting for a purchase request to complete\n      state = PsiCashUIState.BUYING_BOOST;\n    }\n\n    // Speed Boost cannot function in L2TP/IPSec mode. We want to disabled controls and\n    // indicate why we're in that state.\n    if (g_initObj.Settings.VPN) {\n      state = PsiCashUIState.VPN_MODE_DISABLED;\n    }\n\n    // Show and hide the appropriate parts of the UI\n    $('.psicash-interface').not(state.uiSelector).addClass('hidden');\n    $(state.uiSelector).removeClass('hidden');\n\n    // Now that the correct interface is showing, update the balance\n    PsiCashBalanceChange.push(psicashData.balance, veryFirstUpdate);\n\n    // When we have an active speed boost, we want this function to be called repeatedly,\n    // so that the countdown timer is updated, and so the UI changes when the speed boost\n    // ends. But there's no reason to do work on an interval if there's no active boost.\n    if (state === PsiCashUIState.ACTIVE_BOOST) {\n      // There are triggers that result in this function being called, and we don't want\n      // to create periodic update timeouts every time, or else we'll end up with updates\n      // happening way too often (multiple times per second).\n      clearTimeout(psiCashUIUpdater.timeout);\n\n      // Wait longer between updates if there's a lot of time left in the boost.\n      if (millisOfSpeedBoostRemaining < 120 * 1000) {\n        psiCashUIUpdater.timeout = setTimeout(psiCashUIUpdater, 1000);\n      }\n      else {\n        psiCashUIUpdater.timeout = setTimeout(psiCashUIUpdater, 60 * 1000);\n      }\n    }\n\n    PsiCashStore.set('uiState', state);\n  }\n\n  /**\n   * Update the UI to a new balance, complete with animations.\n   * @param {number} newBalance The balance to update the UI to match.\n   * @param {boolean} veryFirstUpdate Whether this is the very first balance update\n   *    (determines which animations are used).\n   * @returns {jQuery.Promise} A promise that will be resolved when the update animations\n   *    are complete.\n   */\n  function doBalanceChange(newBalance, veryFirstUpdate) {\n    const allDoneDefer = $.Deferred();\n\n    let previousBalance = parseInt($('.psicash-balance').data('psicash-balance')); // may be NaN\n    if (_.isNaN(previousBalance)) {\n      // If this is the very first refresh after the UI is enabled, we want to animate the\n      // balance change. But if this is just an app start-up that's restoring a previous\n      // balance, then we don't.\n      const startingPoint = veryFirstUpdate ? 0 : newBalance;\n      $('.psicash-balance').text(formatPsi(startingPoint)).data('psicash-balance', startingPoint);\n      previousBalance = startingPoint;\n    }\n    else {\n      // Update the value of the balance field. This is mostly so that a post-language-change\n      // refresh will show the balance in the correct format.\n      $('.psicash-balance').text(formatPsi(previousBalance));\n    }\n\n    let balanceDiff = newBalance - previousBalance;\n\n    // If the diff is 0, we're not going to update anything. Otherwise we're going to\n    // animate the change.\n    if (balanceDiff === 0) {\n      allDoneDefer.resolve();\n    }\n    else {\n      balanceDiff = _.isNaN(balanceDiff) ? newBalance : balanceDiff;\n\n      // Set the data value to the real balance immediately, to prevent later confusion.\n      $('.psicash-balance').data('psicash-balance', newBalance);\n\n      // We're going to animate the balance increasing. We need to figure out the steps.\n      const BILLION = 1e9;\n      const balanceStepTime = 2000;   // ms\n      const balanceStopInterval = 25; // ms\n      const maxSteps = Math.trunc(balanceStepTime / balanceStopInterval);\n\n      // We only want to consider billions\n      const gigaBalanceDiff = balanceDiff / BILLION;\n\n      let balanceStepCount = Math.max(1, Math.min(Math.abs(gigaBalanceDiff), maxSteps));\n      const balanceStepSize = Math.trunc(gigaBalanceDiff / balanceStepCount) * BILLION;\n\n      // If we only stepped balanceStepSize, the last step might be huge. So we'll\n      // take some larger steps at the start.\n      let extraStepSize = balanceDiff - (Math.sign(balanceDiff) * balanceStepCount * balanceStepSize);\n\n      let intermediateBalance = previousBalance;\n\n      const $visiblePsiCashInterface = $('#psicash-block .psicash-interface').not('.hidden');\n      const $visibleBalanceElem = $visiblePsiCashInterface.find('.psicash-balance');\n\n      // There are two different aynchronous animations that we want to want to wait\n      // on before declaring this balance change complete: The number ticking up or down,\n      // and the CSS delta transition. We're going to use promises to keep track of them finishing.\n      const tickDefer = $.Deferred();\n      const deltaDefer = $.Deferred();\n      $.when(tickDefer.promise(), deltaDefer.promise()).always(() => {\n        // Resolve the master deferred\n        allDoneDefer.resolve();\n      });\n\n      const finalTickStep = (balanceTickInterval) => {\n        if (!balanceTickInterval) {\n          return;\n        }\n        clearInterval(balanceTickInterval);\n        balanceTickInterval = null;\n        // Update all balance fields, not just the visible one.\n        $('.psicash-balance').text(formatPsi(newBalance));\n        // Ticking is all done\n        tickDefer.resolve();\n      };\n\n      let balanceTickInterval = setInterval(() => {\n        balanceStepCount--;\n        if (balanceStepCount < 1) {\n          // Ticking is done\n          finalTickStep(balanceTickInterval);\n          return;\n        }\n\n        intermediateBalance += balanceStepSize;\n        if (extraStepSize > BILLION) {\n          intermediateBalance += BILLION;\n          extraStepSize -= BILLION;\n        }\n        $visibleBalanceElem.text(formatPsi(intermediateBalance));\n      }, 10)\n\n      // If our animation is super slow, the whole thing might take too long, so we're\n      // also going to time-bound the whole process.\n      setTimeout(() => {\n        finalTickStep(balanceTickInterval);\n      }, balanceStepTime);\n\n      // We're going to test that $visibleBalanceElem actually exists, otherwise we risk\n      // never resolving the animation promise.\n      if ($visibleBalanceElem.length > 0) {\n        let psiText = formatPsi(balanceDiff);\n        if (balanceDiff > 0) {\n          // Negative numbers naturally get a '-', but we'll need to add a '+' sign (localized)\n          psiText = i18n.t('positive-value-indicator').replace('%d', formatPsi(balanceDiff));\n        }\n\n        // Create and insert the element we'll use for the animation\n        const $deltaElem = $('<span class=\"psicash-balance-delta\"></span>')\n                            .addClass((balanceDiff > 0) ? 'credit' : 'debit')\n                            .text(psiText)\n                            .insertAfter($visibleBalanceElem);\n\n        // It's unfortunate that we have to do the animation using jQuery's .animate()\n        // rather than CSS transitions, but transitions seem flaky in IE.\n        const animationCSSEnpoint = (balanceDiff > 0) ?\n          // credit\n          {\n            'font-size': '0',\n            'opacity': '0.4'\n          } :\n          // debit\n          {\n            'font-size': '500%',\n            'opacity': '0'\n          };\n\n        const animationPromise = $deltaElem\n          .delay(10)\n          .addClass('balance-changing')\n          .animate(animationCSSEnpoint, {\n            duration: (balanceDiff > 0) ? 2000 : 2000,\n            easing: 'swing',\n            queue: true })\n          .promise();\n\n        animationPromise.always(() => {\n            $deltaElem.remove();\n            deltaDefer.resolve();\n        });\n      }\n      else {\n        // We're not doing the transition animation, so just resolve the deferred\n        deltaDefer.resolve();\n      }\n    }\n\n    return allDoneDefer.promise();\n  }\n\n  /**\n   * Used to queue balance changes. Required to make sure animations don't get messed up.\n   */\n  const PsiCashBalanceChange = {\n    /**\n     * The queue of balances to change to\n     * @type {number[]}\n     * @private\n     */\n    _queue: [],\n\n    /**\n     * Whether the next balance change will be the very first one\n     * @type {boolean}\n     * @private\n     */\n    _first: false,\n\n    /**\n     * Enqueues the given balance to change the UI to.\n     * @param {!number} newBalance The balance to change to.\n     * @param {!boolean} first Whether this is the very first balance change ever (not just\n     *  a fresh app start-up).\n     */\n    push: function PsiCashBalanceChange_push(newBalance, first) {\n      if (!_.isNumber(newBalance)) {\n        return;\n      }\n\n      // This properly be stored in the queue, but it doesn't matter. There will only ever\n      // be one \"first\", and it'll be the first change.\n      this._first = first;\n\n      this._queue.push(newBalance);\n\n      if (this._queue.length === 1) {\n        // We're not already processing the queue and need to start\n        nextTick(this._pop, this);\n      }\n    },\n\n    /**\n     * @private\n     */\n    _pop: function PsiCashBalanceChange_pop() {\n      if (this._queue.length === 0) {\n        // We're done\n        return;\n      }\n\n      // We process the next item in the queue before removing it. Its presence acts as a\n      // flag that we're processing.\n      const nextBalance = this._queue[0];\n      const changePromise = doBalanceChange(nextBalance, this._first);\n      this._first = false;\n\n      changePromise.always(() => {\n        this._queue.shift();\n        // Keep processing the queue\n        this._pop();\n      });\n    }\n  };\n\n  /**\n   * Gets the moment locale matching the current UI locale.\n   * @returns {!string}\n   */\n  function momentLocale() {\n    let locale = $('html').attr('lang');\n    if (_.startsWith(locale, 'dev')) {\n      // Moment has different locale codes for pseudolocales.\n      locale = 'x-pseudo';\n    }\n\n    // `locale` is now our starting point. Moment has case-sensitive locale matches, but\n    // also has case-inconsistent locale names (e.g., it has \"en-SG\" in the current\n    // release, although that looks to be changed in a future release). It also has\n    // exact matching, so it won't recognize \"zh\" even though it has \"zh-cn\". So we\n    // need to do some massaging and fuzzy-matching.\n    locale = locale.toLowerCase();\n\n    // Just in case we have \"en_US\" instead of \"en-US\".\n    locale = locale.replace('_', '-');\n\n    // Moment uses \"uz-latn\" rather than \"uz@Latn\"\n    locale = locale.replace('@', '-');\n\n    let subLocale = locale.split('-')[0];\n\n    let exactLocaleMatch, subLocaleMatch;\n    const momentLocales = moment.locales();\n    for (let i = 0; i < momentLocales.length; i++) {\n      const l = momentLocales[i];\n      if (l.toLowerCase() === locale) {\n        exactLocaleMatch = l;\n        break;\n      }\n\n      // We'll also check \"sub-locales\". This means that if locale is \"pt-pt\" then we want\n      // to match \"pt\", and if locale is \"zh\" we want to match \"zh-cn\".\n      if (subLocale === l) {\n        subLocaleMatch = l;\n      }\n      // HACK: We're only going to record the first sub-locale match, because we know\n      // that \"zh-cn\" will come before \"zh-tw\", and that's what we want to match for \"zh\".\n      else if (!subLocaleMatch && subLocale === l.split('-')[0]) {\n        subLocaleMatch = l;\n      }\n    }\n\n    if (!exactLocaleMatch) {\n      if (!subLocaleMatch) {\n        DEBUG_WARN('missing momentjs locale:', locale, '; falling back to English');\n      }\n      else {\n        DEBUG_WARN('missing momentjs locale:', locale, '; using sublocale match:', subLocaleMatch);\n      }\n    }\n\n    return exactLocaleMatch || subLocaleMatch || 'en';\n  }\n\n  /**\n   * Event handler for the \"buy speed boost\" button click.\n   */\n  function buySpeedBoostClick() {\n    if (g_lastState !== 'connected') {\n      showNoticeModal(\n        'psicash#mustconnect-modal#title',\n        'psicash#mustconnect-modal#body',\n        null, null,\n        function() {\n          switchToTab('#connection-tab');\n        }\n      );\n      return;\n    }\n\n    const distinguisher = $(this).data('distinguisher');\n    const expectedPrice = $(`.psicash-sb-price[data-distinguisher=\"${distinguisher}\"]`).data('expectedPrice');\n\n    // Set the purchase-in-progress state and update UI.\n    PsiCashStore.set('purchaseInProgress', true);\n    psiCashUIUpdater();\n\n    HtmlCtrlInterface_PsiCashCommand(new PsiCashCommandPurchase(\n      'speed-boost', distinguisher, expectedPrice))\n      .then((result) => {\n        // Clear the purchase-in-progress state and update UI.\n        PsiCashStore.set('purchaseInProgress', false);\n        if (result.refresh) {\n          // The reponse supplied refresh data\n          psiCashUIUpdater(result.refresh);\n        }\n        else {\n          // We need to do a full refresh\n          HtmlCtrlInterface_PsiCashCommand(new PsiCashCommandRefresh('purchase-response'));\n        }\n\n        if (result.error) {\n          // Catastrophic failure. Show a modal error and hope the user can figure it out.\n          showNoticeModal(\n            'psicash#transaction-error-title',\n            'psicash#transaction-error-body',\n            'general#notice-modal-tech-preamble',\n            result.error,\n            null); // callback\n        }\n        else {\n          switch (result.status) {\n            case PsiCashServerResponseStatus.ExistingTransaction:\n              // There's an existing transaction that this purchase attempt conflicts with.\n              // This is a weird state, since a non-expired purchase should have prevented\n              // the purchase attempt in the first place. Hopefully the attempt request has\n              // corrected our clock skew with the server, and now the existing purchase\n              // will be indicated correctly.\n              showNoticeModal(\n                'psicash#transaction-ExistingTransaction-title',\n                'psicash#transaction-ExistingTransaction-body',\n                null,  // tech detail preamble\n                null,  // tech detail body\n                null); // callback\n              break;\n\n            case PsiCashServerResponseStatus.InsufficientBalance:\n              // The user doesn't have enough credit to make this purchase. This is unusual,\n              // as we don't allow the user to have make a purchase that they can't afford.\n              // It can happen if the user has local \"optimistic\" credit that hasn't cleared\n              // on the server, or if the user's balance has changed elsewhere. (But we\n              // don't actually have optimistic balance usage in the Windows client yet.)\n              showNoticeModal(\n                'psicash#transaction-InsufficientBalance-title',\n                'psicash#transaction-InsufficientBalance-body',\n                null,  // tech detail preamble\n                null,  // tech detail body\n                null); // callback\n              break;\n\n            case PsiCashServerResponseStatus.TransactionAmountMismatch:\n              // The price that we thought the purchase cost is different from what the server\n              // thinks it costs. We'll need a data refresh to get new prices.\n              showNoticeModal(\n                'psicash#transaction-TransactionAmountMismatch-title',\n                'psicash#transaction-TransactionAmountMismatch-body',\n                null,  // tech detail preamble\n                null,  // tech detail body\n                null); // callback\n              break;\n\n            case PsiCashServerResponseStatus.TransactionTypeNotFound:\n              // The kind of thing we try tried to buy doesn't exist on the server. This is\n              // very unlikely to happen, except maybe for very old clients.\n              showNoticeModal(\n                'psicash#transaction-TransactionTypeNotFound-title',\n                'psicash#transaction-TransactionTypeNotFound-body',\n                null,  // tech detail preamble\n                null,  // tech detail body\n                null); // callback\n              break;\n\n            case PsiCashServerResponseStatus.InvalidTokens:\n              // The tokens we tried to use were not accepted by the server.\n              // This shouldn't happen for Trackers, barring DB replication lag.\n              // TODO: support Accounts\n              showNoticeModal(\n                'psicash#transaction-InvalidTokens-title',\n                'psicash#transaction-InvalidTokens-body',\n                null,  // tech detail preamble\n                null,  // tech detail body\n                null); // callback\n              break;\n\n            case PsiCashServerResponseStatus.ServerError:\n              // The server gave a 500-ish error\n              showNoticeModal(\n                'psicash#transaction-ServerError-title',\n                'psicash#transaction-ServerError-body',\n                null,  // tech detail preamble\n                null,  // tech detail body\n                null); // callback\n              break;\n\n            case PsiCashServerResponseStatus.Success:\n              // The purchase succeeded. We need to reconnect to apply the authorization.\n              displayCornerAlert($('#psicash-transaction-purchase-complete'));\n              // Suppress home page opening after reconnect (because it's a terrible UX).\n              HtmlCtrlInterface_ReconnectTunnel(true);\n              break;\n\n            default:\n              throw new Error('Unknown PsiCashServerResponseStatus received: ' + result.status);\n          }\n        }\n      });\n  }\n  $('.psicash-buy').click(buySpeedBoostClick);\n\n\n  /**\n   * Event handler for the \"buy PsiCash with real money\" button click.\n   */\n  function buyPsiClick(e) {\n    if (g_lastState !== 'connected') {\n      e.preventDefault();\n      showNoticeModal(\n        'psicash#mustconnect-modal#title',\n        'psicash#mustconnect-modal#body',\n        null, null,\n        function() {\n          switchToTab('#connection-tab');\n        }\n      );\n      return;\n    }\n    // Otherwise allow the default action\n  }\n  $('a.psicash-buy-psi').click(buyPsiClick);\n\n  /**\n   * Format a numeric amount of PsiCash, for display in the UI.\n   * @param {!number} nanopsi The amount of PsiCash, in nanopsi.\n   * @returns {!string} The formatted PsiCash value.\n   */\n  function formatPsi(nanopsi) {\n    if (!_.isNumber(nanopsi)) {\n      nanopsi = parseInt(nanopsi);\n    }\n\n    var BILLION = 1e9;\n\n    var currLang = $('html').attr('lang');\n\n    // NOTE: If you're testing in Chrome, toLocaleString will behave differently than in IE.\n    // For example, in Chrome locale='ar' doesn't seem to result in any change, but\n    // locale='ar-EG' does. In IE11 they both do.\n\n    var psi = nanopsi / BILLION;\n    // Reduce to two decimal places for display\n    psi = Math.floor(psi * 100) / 100;\n    // Localize number\n    try {\n      psi = psi.toLocaleString(currLang);\n    }\n    catch (e) {\n      // Our test locales (like devltr) are no valid and will cause an exception. Just fall\n      // back to English.\n      psi = psi.toLocaleString('en');\n    }\n\n    // Old IE seems to always localize to English, with `.00` suffix. We want to strip off\n    // that suffix.\n    if (psi.substring(psi.length - '.00'.length) === '.00') {\n      psi = psi.substring(0, psi.length - '.00'.length);\n    }\n\n    return psi;\n  }\n\n  /**\n   * Called when tunnel core indicates that there was an attempt to access a\n   * port disallowed by the current traffic rules. We will show an alert to\n   * encourage the user to buy Speed Boost.\n   */\n  function handleDisallowedTrafficNotice() {\n    if (PsiCashStore.data.uiState === PsiCashUIState.ACTIVE_BOOST) {\n      // If we're boosting, then any disallowed traffic is something that won't\n      // be let through by purchasing speed boost, so logging, etc., is pointless.\n      DEBUG_LOG('handleDisallowedTrafficNotice: already boosting');\n      return;\n    }\n\n    addLog({\n      priority: 2, // high\n      message: 'Disallowed traffic detected; please purchase Speed Boost'\n    });\n\n    if (g_initObj.Settings.DisableDisallowedTrafficAlert) {\n      // User has disabled this alert in the settings\n      DEBUG_LOG('handleDisallowedTrafficNotice: DisableDisallowedTrafficAlert is true');\n      return;\n    }\n\n    if (!handleDisallowedTrafficNotice.alertDisallowedTraffic) {\n      // We have already shown the alert this session.\n      DEBUG_LOG('handleDisallowedTrafficNotice: alert already shown this session');\n      return;\n    }\n    // else show the alert\n\n    DEBUG_LOG('handleDisallowedTrafficNotice: showing alert');\n\n    handleDisallowedTrafficNotice.alertDisallowedTraffic = false;\n\n    HtmlCtrlInterface_DisallowedTraffic()\n\n    showNoticeModal(\n      'notice#disallowed-traffic-alert-title',\n      'notice#disallowed-traffic-alert-body',\n      null, null, () => {\n        if (compareIEVersion('gte', 9, true)) {\n          const psicashBlock = $('#psicash-block');\n          if (!psicashBlock.hasClass('hidden')) {\n            $('#psicash-block').addClass('draw-attention');\n            // The animation is 1s of movement, and we want the effect to linger for a bit.\n            setTimeout(() => $('#psicash-block').removeClass('draw-attention'), 1500);\n          }\n        }\n      });\n  }\n  handleDisallowedTrafficNotice.alertDisallowedTraffic = true;\n  $window.on(CONNECTED_STATE_CHANGE_EVENT, () => {\n    if (g_lastState === 'stopped') {\n      // After a hard stop, we will again show the \"disallowed traffic\" alert one time.\n      DEBUG_LOG('handleDisallowedTrafficNotice: resetting alertDisallowedTraffic to true because connected state stopped');\n      handleDisallowedTrafficNotice.alertDisallowedTraffic = true;\n    }\n  });\n  PsiCashStore.subscribe('uiState', () => {\n    if (PsiCashStore.data.uiState === PsiCashUIState.ACTIVE_BOOST &&\n        !handleDisallowedTrafficNotice.boosting) {\n      DEBUG_LOG('handleDisallowedTrafficNotice: boost started');\n      handleDisallowedTrafficNotice.boosting = true;\n    }\n    else if (handleDisallowedTrafficNotice.boosting) {\n      // We were boosting and now we're not. Show the \"disallowed traffic\" alert again.\n      DEBUG_LOG('handleDisallowedTrafficNotice: resetting alertDisallowedTraffic to true because boost ended');\n      handleDisallowedTrafficNotice.boosting = false;\n      handleDisallowedTrafficNotice.alertDisallowedTraffic = true;\n    }\n  });\n\n  /* UI HELPERS ****************************************************************/\n\n  function displayCornerAlert(elem) {\n    // Show -- and then hide -- the alert\n    var appearAnimationTime = 300;\n    var showingTime = 4000;\n    var disappearAnimationTime = 1000;\n    $(elem).toggle('fold', {horizFirst: true}, appearAnimationTime, function() {\n      setTimeout(function() {\n        $(elem).toggle('fold', {horizFirst: true}, disappearAnimationTime);\n      }, showingTime);\n    });\n  }\n\n  // Make the given tab visible. `tab` may be a selector, a DOM element, or a\n  // jQuery object. If `callback` is provided, it will be invoked when tab is shown.\n  function switchToTab(tab, callback) {\n    var $tab = $(tab);\n    if ($tab.hasClass('active')) {\n      // Tab already showing.\n      if (callback) {\n        nextTick(callback);\n      }\n    }\n    else {\n      // Settings tab not already showing. Switch to it before expanding and scrolling.\n      if (callback) {\n        $tab.find('[data-toggle=\"tab\"]').one('show', callback);\n      }\n      $tab.find('[data-toggle=\"tab\"]').tab('show');\n    }\n  }\n\n  /**\n   * Shows a modal box. String table keys will be used for filling in the content.\n   * The \"tech\" values are optional.\n   * @param {!string} titleKey\n   * @param {!string} bodyKey\n   * @param {?string} techPreambleKey\n   * @param {?string} techInfoString An explicit string -- not a string table key.\n   * @param {?callback} closedCallback Optional and will be called when the modal is closed.\n   */\n  function showNoticeModal(titleKey, bodyKey, techPreambleKey, techInfoString, closedCallback) {\n    DEBUG_ASSERT(titleKey && bodyKey, 'missing titleKey or bodyKey', titleKey, bodyKey);\n\n    var $modal = $('#NoticeModal');\n\n    $modal.find('.modal-title').html(i18n.t(titleKey));\n    $modal.find('.notice-modal-body').html(i18n.t(bodyKey));\n\n    if (techPreambleKey && techInfoString) {\n      $modal.find('.notice-modal-tech-preamble').html(i18n.t(techPreambleKey));\n      $modal.find('.notice-modal-tech-info').text(techInfoString);\n      $modal.find('.notice-modal-tech').removeClass('hidden');\n    }\n    else {\n      $modal.find('.notice-modal-tech').addClass('hidden');\n    }\n\n    // Put up the modal\n    $modal.modal({\n      show: true,\n      backdrop: 'static'\n    }).one('hidden', function() {\n      if (closedCallback) {\n        closedCallback();\n      }\n    });\n  }\n\n  /* MISC HELPERS AND UTILITIES ************************************************/\n\n  // Support the `data-match-height` feature.\n  function doMatchHeight() {\n    var i, j, $elem, matchSelector, matchSelectorsToMaxHeight = {}, $matchSelectorMatches;\n    var $elemsToChange = $('[data-match-height]');\n\n    //\n    // Reset previously adjusted heights; record the match selectors.\n    //\n    for (i = 0; i < $elemsToChange.length; i++) {\n      $elem = $elemsToChange.eq(i);\n\n      // Store the original padding, if we don't already have it.\n      if (_.isUndefined($elem.data('match-height-orig-padding-top'))) {\n        $elem.data('match-height-orig-padding-top', parseInt($elem.css('padding-top')))\n             .data('match-height-orig-padding-bottom', parseInt($elem.css('padding-bottom')));\n      }\n\n      // Reset the padding to its original state\n      $elem.css('padding-top', $elem.data('match-height-orig-padding-top'))\n           .css('padding-bottom', $elem.data('match-height-orig-padding-bottom'));\n\n      matchSelector = $elem.data('match-height');\n      matchSelectorsToMaxHeight[matchSelector] = null;\n    }\n\n    //\n    // Alter the heights.\n    //\n    for (i = 0; i < $elemsToChange.length; i++) {\n      $elem = $elemsToChange.eq(i);\n      matchSelector = $elem.data('match-height');\n\n      // If we haven't already determined the max for this selector, calculate it\n      if (matchSelectorsToMaxHeight[matchSelector] === null) {\n        $matchSelectorMatches  = $(matchSelector);\n        for (j = 0; j < $matchSelectorMatches.length; j++) {\n          matchSelectorsToMaxHeight[matchSelector] = Math.max(\n            matchSelectorsToMaxHeight[matchSelector],\n            $matchSelectorMatches.eq(j).height());\n        }\n      }\n\n      // Alter the height.\n      matchHeight($elem, matchSelectorsToMaxHeight[matchSelector]);\n    }\n\n    function matchHeight($elem, height) {\n      var heightDiff = height - $elem.height();\n      if (heightDiff <= 0) {\n        // Already at least big enough\n        return;\n      }\n\n      var align = $elem.data('match-height-align');\n      if (align === 'top') {\n        $elem.css('padding-bottom', heightDiff + $elem.data('match-height-orig-padding-bottom'));\n      }\n      else if (align === 'bottom') {\n        $elem.css('padding-top', heightDiff + $elem.data('match-height-orig-padding-top'));\n      }\n      else { // center\n        $elem.css('padding-top', heightDiff/2 + $elem.data('match-height-orig-padding-top'))\n             .css('padding-bottom', heightDiff/2 + $elem.data('match-height-orig-padding-bottom'));\n      }\n    }\n  }\n\n  // Support the `data-match-width` feature\n  function doMatchWidth() {\n    var matchSelectors = [], $dataMatchElems, $elem,\n        matchSelector, $matchMaxElems, matchSelectorMaxWidth, i, j;\n\n    $dataMatchElems = $('[data-match-width]');\n\n    // First reset the widths of all the elements we will be adjusting. Otherwise\n    // the find-max-width will be tainted if an element-to-adjust is also part of\n    // of the find-max-width selector.\n    for (i = 0; i < $dataMatchElems.length; i++) {\n      $elem = $dataMatchElems.eq(i);\n      $elem.css('width', '');\n\n      // Build up a list of the selectors used, with dependent ones at the end.\n      matchSelector = $elem.data('match-width');\n      if (!_.includes(matchSelectors, matchSelector)) {\n        if ($elem.data('match-width-dependent') === 'true') {\n          matchSelectors.push(matchSelector);\n        }\n        else {\n          matchSelectors.unshift(matchSelector);\n        }\n      }\n    }\n\n    // Then collect the maximums for each of the selectors provided by data-match-width\n    for (i = 0; i < matchSelectors.length; i++) {\n      matchSelector = matchSelectors[i];\n\n      matchSelectorMaxWidth = 0.0;\n      $matchMaxElems = $(matchSelector);\n      for (j = 0; j < $matchMaxElems.length; j++) {\n        matchSelectorMaxWidth = Math.max(\n                                  matchSelectorMaxWidth,\n                                  $matchMaxElems.eq(j).outerWidth());\n      }\n\n      // Apply the max width to the target elements.\n      $dataMatchElems = $('[data-match-width=\"' + matchSelector + '\"]');\n      for (j = 0; j < $dataMatchElems.length; j++) {\n        $elem = $dataMatchElems.eq(j);\n        $elem.width(getNetWidth($elem, matchSelectorMaxWidth));\n      }\n    }\n\n    function getNetWidth($elem, grossWidth) {\n      return grossWidth -\n              (parseFloat($elem.css('padding-right')) || 0) -\n              (parseFloat($elem.css('padding-left')) || 0) -\n              (parseFloat($elem.css('border-right-width')) || 0) -\n              (parseFloat($elem.css('border-left-width')) || 0) -\n              (parseFloat($elem.css('margin-right')) || 0) -\n              (parseFloat($elem.css('margin-left')) || 0);\n    }\n  }\n\n  function getIEVersion() {\n    // This is complicated by the fact that the MSHTML control uses a different\n    // user agent string than browsers do.\n\n    var ie7_10Match, ie11Match, edgeMatch, tridentMatch, msieMatch;\n\n    var ieVersion = false;\n\n    // User agents differ between browser and actual application, so we need\n    // different checks\n\n    if (IS_BROWSER) {\n      // Some care needs to be taken to work with IE11+'s old-version test mode.\n      // We can't just use Trident versions.\n\n      // This will match IEv7-10.\n      ie7_10Match = window.navigator.userAgent.match(/^Mozilla\\/\\d\\.0 \\(compatible; MSIE (\\d+)/);\n      // This will match IE11.\n      ie11Match = window.navigator.userAgent.match(/Trident\\/(\\d+)/);\n      // This will match Edgev1 (which we will consider IE12).\n      edgeMatch = window.navigator.userAgent.match(/Edge\\/(\\d+)/);\n\n      if (ie7_10Match) {\n        ieVersion = parseInt(ie7_10Match[1]);\n      }\n      else if (ie11Match) {\n        // Trident version is 4 versions behind IE version.\n        ieVersion = parseInt(ie11Match[1]) + 4;\n      }\n      else if (edgeMatch) {\n        ieVersion = parseInt(edgeMatch[1]);\n      }\n    }\n    else {\n      // This will match MSHTMLv8-11.\n      tridentMatch = window.navigator.userAgent.match(/MSIE \\d+.*Trident\\/(\\d+)/);\n      // This will match MSHTMLv7. Note that it must be checked after the Trident match.\n      msieMatch = window.navigator.userAgent.match(/MSIE (\\d+)/);\n\n      // This will match Edgev1 (which we will consider IE12).\n      // Note that this hasn't been seen in the Wild. MSHTML on Win10 uses Trident/8,\n      // which hits the above regex and returns version 12.\n      edgeMatch = window.navigator.userAgent.match(/Edge\\/(\\d+)/);\n\n      if (tridentMatch) {\n        // Trident version is 4 versions behind IE version.\n        ieVersion = parseInt(tridentMatch[1]) + 4;\n      }\n      else if (msieMatch) {\n        ieVersion = parseInt(msieMatch[1]);\n      }\n      else if (edgeMatch) {\n        ieVersion = parseInt(edgeMatch[1]);\n      }\n    }\n\n    return ieVersion;\n  }\n\n  // `comparison` may be: 'eq', 'lt', 'gt', 'lte', 'gte'\n  function compareIEVersion(comparison, targetVersion, acceptNonIE) {\n    var ieVersion = getIEVersion();\n\n    if (ieVersion === false) {\n      return acceptNonIE;\n    }\n\n    if (comparison === 'eq') {\n      return ieVersion == targetVersion;\n    }\n    else if (comparison === 'lt') {\n      return ieVersion < targetVersion;\n    }\n    else if (comparison === 'gt') {\n      return ieVersion > targetVersion;\n    }\n    else if (comparison === 'lte') {\n      return ieVersion <= targetVersion;\n    }\n    else if (comparison === 'gte') {\n      return ieVersion >= targetVersion;\n    }\n\n    return false;\n  }\n\n  //\n  // We don't have the ability to use real cookies or DOM storage, so we'll store\n  // persistent stuff in the registry via the win32 code.\n  //\n  var g_cookies = g_initObj.Cookies ? JSON.parse(g_initObj.Cookies) : {};\n\n  /**\n   * Retrieves the stored cookie value associated with `name`.\n   * @param {string} name\n   * @returns {} The value for `name`. May be null or undefined.\n   */\n  function getCookie(name) {\n    if (IS_BROWSER) {\n      return JSON.parse(window.localStorage.getItem(name)) || g_cookies[name];\n    }\n\n    return g_cookies[name];\n  }\n\n  /**\n   * Persistently stores `value` under the key `name`.\n   * @param {string} name The key to store the `value` under.\n   * @param {} value The value to be stored. Must be JSON-able.\n   */\n  function setCookie(name, value) {\n    if (IS_BROWSER) {\n      window.localStorage.setItem(name, JSON.stringify(value));\n    }\n\n    g_cookies[name] = value;\n    HtmlCtrlInterface_SetCookies(JSON.stringify(g_cookies));\n  }\n\n\n  // Sets a short timeout and then calls `callback`\n  // `context` is optional. Will be `this` when `callback` is called.\n  function nextTick(callback, context) {\n    nextTickFn(callback, context)();\n  }\n\n  // Creates a function that, when called, sets a short timeout and then calls `callback`\n  // `context` is optional. Will be `this` when `callback` is called.\n  function nextTickFn(callback, context) {\n    return function nextTickFnInner() {\n      var args = arguments;\n      var runner = function() {\n        callback.apply(context, args);\n      };\n\n      setTimeout(runner, 0);\n    };\n  }\n\n  // Convert hex-style color (#FFFFFF or #FFF) to RGB style (rgb(255, 255, 255)).\n  // From http://stackoverflow.com/a/5624139/729729\n  function hexToRgb(hex) {\n    // Expand shorthand form (e.g. \"03F\") to full form (e.g. \"0033FF\")\n    var shorthandRegex = /^#?([a-f\\d])([a-f\\d])([a-f\\d])$/i;\n    hex = hex.replace(shorthandRegex, function(m, r, g, b) {\n      return r + r + g + g + b + b;\n    });\n\n    var result = /^#?([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})$/i.exec(hex);\n    return result ? {\n      r: parseInt(result[1], 16),\n      g: parseInt(result[2], 16),\n      b: parseInt(result[3], 16)\n    } : null;\n  }\n\n  // Draws attention to a button. Note that this may require some extra styling\n  // to fully work (so test accordingly).\n  function drawAttentionToButton(elem) {\n    // We will draw attention by temporarily flaring a box-shadow, and then\n    // wiggling the button. The wiggle comes from CSS animation (see main.less).\n\n    var backgroundColor, backgroundColorRGB, shadowColor;\n    var $elem = $(elem);\n\n    var originalBoxShadow = $elem.data('drawAttentionToButton-originalBoxShadow');\n    if (!originalBoxShadow) {\n      originalBoxShadow = $elem.css('box-shadow');\n      $elem.data('drawAttentionToButton-originalBoxShadow', originalBoxShadow);\n    }\n\n    // The box shadow will be same colour as the button background, with reduced\n    // opacity.\n\n    backgroundColor = $elem.css('background-color');\n    if (!backgroundColor) {\n      backgroundColor = '#999';\n    }\n\n    if (backgroundColor[0] === '#') {\n      // hex style; convert to rgb\n      backgroundColorRGB = hexToRgb(backgroundColor);\n      backgroundColor = 'rgb(' + backgroundColorRGB.r + ', ' +\n                                 backgroundColorRGB.g + ', ' +\n                                 backgroundColorRGB.b + ')';\n    }\n\n    // Only add alpha if this is a rgb(..) colour, and not rgba(...) or anything else.\n    if (backgroundColor.slice(0, 4) === 'rgb(') {\n      shadowColor = 'rgba(' + backgroundColor.slice(4, -1) + ', 0.7)';\n    }\n    else {\n      shadowColor = backgroundColor;\n    }\n\n    // The effect we're going for is the color draining from outside into the button.\n    var animationTimeSecs = 3;\n\n    // Add the initial internal and external shadow\n    $elem.css({\n      'transition': '',\n      'box-shadow': 'inset 0 0 100px #FFF, 0 0 10px ' + shadowColor\n    });\n\n    // After giving that CSS change a moment to take effect...\n    _.delay(function() {\n      // ...add a transition and remove the box shadow. It will disappear slowly.\n      $elem.css({\n        'transition': 'box-shadow ' + animationTimeSecs + 's',\n        'box-shadow': 'none'\n      });\n\n      // When the big box shadow is gone, reset to the original value\n      $elem.one('transitionend', function() {\n        $elem.css({\n          'transition': '',\n          'box-shadow': originalBoxShadow\n        });\n      });\n    }, 10); // if this is too low, the effect seems to fail sometimes (like when a port number field is changed in settings)\n  }\n\n  function DEBUG_ASSERT(check) {\n    if (g_initObj.Config.Debug) {\n      if (_.isFunction(check)) {\n        check = check();\n      }\n\n      if (!check) {\n        let message = 'DEBUG_ASSERT failed: ' + check + '; args: \\n';\n        for (let i = 1; i < arguments.length; i++) {\n          message += '\\t' + arguments[i] + '\\n'\n        }\n        throw new Error(message);\n      }\n    }\n  }\n\n  /**\n   * Returns true if the windows currently has focus; false otherwise.\n   * @returns {boolean}\n   */\n  function windowHasFocus() {\n    return document.hasFocus();\n  }\n\n  /**\n   * Adds a handler that will be called when the windows gets focus.\n   * @param {function} handler\n   */\n  function addWindowFocusHandler(handler) {\n    $window.focus(handler);\n  }\n\n  /**\n   * Generates a pseudo-random string, suitable for non-crypto uniqueness.\n   * @returns {string}\n   */\n  function randomID() {\n    return base64.encode(Math.random());\n  }\n\n  /**\n   * Splits the given URL into components that can be accessed with `result.hash`, etc.\n   * @param {string} url\n   * @returns {HTMLAnchorElement}\n   */\n  function urlComponents(url) {\n    const parser = document.createElement('a');\n    parser.href = url;\n    return parser;\n  }\n\n\n  /* DEBUGGING *****************************************************************/\n\n  // Some functionality to help us debug (and demo) in browser.\n\n  $(function debugInit() {\n    if (!g_initObj.Config.Debug) {\n      $('#debug-tab, #debug-pane').remove();\n      return;\n    }\n\n    // Make the connect button \"work\" in browser mode\n    $('#connect-toggle a').click(function(e) {\n      if (!IS_BROWSER) {\n        return;\n      }\n\n      e.preventDefault();\n      var buttonConnectState = $(this).parents('.connect-toggle-content').data('connect-state');\n      if (buttonConnectState === 'stopped') {\n        console.log('DEBUG: connection starting');\n        HtmlCtrlInterface_SetState({state: 'starting'});\n        setTimeout(function() {\n          HtmlCtrlInterface_SetState({state: 'connected'});\n        }, 5000);\n      }\n      else if (buttonConnectState === 'starting' || buttonConnectState === 'connected') {\n        console.log('DEBUG: connection stopping');\n        HtmlCtrlInterface_SetState({state: 'stopping'});\n        setTimeout(function() {\n          HtmlCtrlInterface_SetState({state: 'stopped'});\n        }, 5000);\n      }\n      // the stopping button is disabled\n    });\n\n    // Keep state combo up-to-date\n    function updateStateCombo() {\n      $('#debug-state').val(g_lastState);\n    }\n    $window.on(CONNECTED_STATE_CHANGE_EVENT, updateStateCombo);\n    updateStateCombo();\n    // Change state when combo changes\n    $('#debug-state').on('change', function() {\n      HtmlCtrlInterface_SetState({state: $('#debug-state').val()});\n    });\n\n    // Wire up AddLog\n    $('#debug-log a').click(function() {\n      HtmlCtrlInterface_AddLog({\n        message: $('#debug-log input').val(),\n        priority: parseInt($('#debug-log select').val())\n      });\n    });\n\n    // Wire up the AvailableEgressRegions notice\n    $('#debug-AvailableEgressRegions a').click(function() {\n      var regions = [], regionCheckboxes = $('#debug-AvailableEgressRegions input');\n      for (var i = 0; i < regionCheckboxes.length; i++) {\n        if (regionCheckboxes.eq(i).prop('checked')) {\n          regions.push(regionCheckboxes.eq(i).val());\n        }\n      }\n      HtmlCtrlInterface_AddNotice({\n        noticeType: 'AvailableEgressRegions',\n        data: { regions: regions }\n      });\n    });\n\n    // Wire up the UpstreamProxyError notice\n    $('#debug-UpstreamProxyError a').click(function() {\n      HtmlCtrlInterface_AddNotice({\n        noticeType: 'UpstreamProxyError',\n        data: { message: $('#debug-UpstreamProxyError input').val() }\n      });\n    });\n\n    // Wire up the HttpProxyPortInUse notice\n    $('#debug-HttpProxyPortInUse a').click(function() {\n      HtmlCtrlInterface_AddNotice({\n        noticeType: 'HttpProxyPortInUse'\n      });\n    });\n\n    // Wire up the SocksProxyPortInUse notice\n    $('#debug-SocksProxyPortInUse a').click(function() {\n      HtmlCtrlInterface_AddNotice({\n        noticeType: 'SocksProxyPortInUse'\n      });\n    });\n\n    // Wire up the SystemProxySettings::SetProxyError test\n    $('#debug-SetProxyError a').click(function() {\n      HtmlCtrlInterface_AddNotice({\n        noticeType: 'SystemProxySettings::SetProxyError'\n      });\n    });\n\n    // Wire up the SystemProxySettings::SetProxyWarning test\n    $('#debug-SetProxyWarning a').click(function() {\n      HtmlCtrlInterface_AddNotice({\n        noticeType: 'SystemProxySettings::SetProxyWarning',\n        data: '[CONN NAME]'\n      });\n    });\n\n    // Wire up the UpdateDpiScaling test\n    $('#debug-UpdateDpiScaling a').click(function() {\n      HtmlCtrlInterface_UpdateDpiScaling({\n        dpiScaling: $('#debug-UpdateDpiScaling input').val()\n      });\n    });\n\n    // Wire up the RefreshPsiCash test\n    $('#debug-RefreshPsiCash a').click(function debugRefreshPsiCashClick() {\n      if (!$('#debug-RefreshPsiCash-balance').val() ||\n          !$('#debug-RefreshPsiCash-price-1hr').val() ||\n          !$('#debug-RefreshPsiCash-price-24hr').val()) {\n        return;\n      }\n\n      const msg = makeTestRefreshMsg(null);\n      HtmlCtrlInterface_PsiCashMessage(msg);\n\n      setCookie('debug-RefreshPsiCash-balance', msg.payload.balance);\n      setCookie('debug-RefreshPsiCash-price-1hr', msg.payload.purchase_prices.find(pp => pp.distinguisher==='1hr').price);\n      setCookie('debug-RefreshPsiCash-price-24hr', msg.payload.purchase_prices.find(pp => pp.distinguisher==='24hr').price);\n    });\n\n    // Wire up the PsiCash InitDone test\n    $('#debug-PsiCashInitDone a').click(function debugPsiCashInitDoneClick() {\n      testInitDoneResponse();\n    });\n\n    const BILLION = 1e9;\n    // Populate the PsiCash balance and price\n    $('#debug-RefreshPsiCash-balance').val(getCookie('debug-RefreshPsiCash-balance') ? getCookie('debug-RefreshPsiCash-balance') / BILLION : '');\n    $('#debug-RefreshPsiCash-price-1hr').val(getCookie('debug-RefreshPsiCash-price-1hr') ? getCookie('debug-RefreshPsiCash-price-1hr') / BILLION : '');\n    $('#debug-RefreshPsiCash-price-24hr').val(getCookie('debug-RefreshPsiCash-price-24hr') ? getCookie('debug-RefreshPsiCash-price-24hr') / BILLION : '');\n\n    // Wire up the Disallowed Traffic test\n    $('#debug-DisallowedTraffic a').click(function debugPsiCashInitDoneClick() {\n      handleDisallowedTrafficNotice();\n    });\n\n  });\n\n  /**\n   * Construct a PsiCashMessageData object from the fields in the debug interface.\n   * @param {?string} msg_id The message.id to use in the \"response\".\n   * @returns {!PsiCashMessageData}\n   */\n  function makeTestRefreshMsg(msg_id) {\n    let purchase = null; /** @type {?PsiCashPurchase} */\n    if ($('#debug-RefreshPsiCash-boost-remaining').val()) {\n      purchase = {\n        id: 'purchase-id',\n        'class': 'speed-boost',\n        distinguisher: '1hr',\n        localTimeExpiry: moment().add(parseFloat($('#debug-RefreshPsiCash-boost-remaining').val()), 'minutes').toISOString()\n      };\n    }\n\n    /** @type {PsiCashMessageData} */\n    let msg = {\n      type: PsiCashMessageTypeEnum.REFRESH,\n      id: msg_id,\n      payload: makeTestRefreshPayload(purchase)\n    }\n\n    return msg;\n  }\n\n  /**\n   *\n   * @param {?PsiCashPurchase} purchase\n   * @returns {PsiCashRefreshData}\n   */\n  function makeTestRefreshPayload(purchase) {\n    const BILLION = 1e9;\n\n    return {\n      valid_token_types: ['spender', 'earner', 'indicator'],\n      balance: parseFloat($('#debug-RefreshPsiCash-balance').val()) * BILLION,\n      purchase_prices: [\n        {\n          'class': 'speed-boost',\n          distinguisher: '1hr',\n          price: parseFloat($('#debug-RefreshPsiCash-price-1hr').val()) * BILLION\n        },\n        {\n          'class': 'speed-boost',\n          distinguisher: '24hr',\n          price: parseFloat($('#debug-RefreshPsiCash-price-24hr').val()) * BILLION\n        }\n      ],\n      purchases: purchase ? [purchase] : null,\n      buy_psi_url: 'https://buy.psi.cash/#psicash=example'\n    };\n  }\n\n  /**\n   * Mimic an init-done message (via C code).\n   */\n  function testInitDoneResponse() {\n    const error = $('#debug-PsiCashInitDone-error')[0].checked;\n    const recovered = $('#debug-PsiCashInitDone-recovered')[0].checked;\n    /** @type {PsiCashMessageData} */\n    const msg = {\n      type: PsiCashMessageTypeEnum.INIT_DONE,\n      id: '',\n      payload: error ? {\n        error: 'test init error message',\n        recovered: recovered\n      } : {}\n    }\n\n    setTimeout(() => HtmlCtrlInterface_PsiCashMessage(msg), 200);\n  }\n\n  /**\n   * Mimic a refresh response from the server (via C code).\n   * @param {!PsiCashCommandPurchase} command\n   */\n  function testRefreshResponse(command) {\n    const msg = makeTestRefreshMsg(command.id);\n    // Pretend the request takes a while.\n    setTimeout(() => HtmlCtrlInterface_PsiCashMessage(msg), 2000);\n  }\n\n  /**\n   * Mimic a purchase response from the server (via C code).\n   * @param {!PsiCashCommandPurchase} command\n   */\n  function testPurchaseResponse(command) {\n    var resp = $('#debug-PsiCashSpeedBoost-response').val();\n\n    /** @type {PsiCashPurchaseResponse} */\n    var msgPayload = {\n      error: null,\n      status: PsiCashServerResponseStatus.Invalid,\n      purchase: null\n    };\n\n    /** @type {PsiCashMessageData} */\n    var msg = {\n      type: PsiCashMessageTypeEnum.NEW_PURCHASE,\n      id: command.id,\n      payload: msgPayload\n    }\n\n    if (resp === 'error') {\n      msg.payload.error = 'debug error';\n    }\n    else if (PsiCashServerResponseStatus[resp] === PsiCashServerResponseStatus.Success) {\n      msg.payload.status = PsiCashServerResponseStatus.Success;\n\n      let expiry = moment().add(1, 'hour').toISOString();\n      if (command.distinguisher === '24hr') {\n        expiry = moment().add(24, 'hour').toISOString();\n      }\n\n      /** @type {PsiCashPurchase} */\n      let purchase = {\n        id: 'debugpurchaseid',\n        'class': command.transactionClass, // quoting key b/c it's a keyword and old IE will complain\n        distinguisher: command.distinguisher,\n        localTimeExpiry: expiry,\n        serverTimeExpiry: expiry\n      };\n      msg.payload.refresh = makeTestRefreshPayload(purchase);\n\n      debugSetPsiCashData({\n        balance: g_PsiCashData.balance-command.expectedPrice,\n        purchases: [purchase]\n      });\n    }\n    else {\n      msg.payload.status = PsiCashServerResponseStatus[resp];\n    }\n\n    // Pretend the request takes a while.\n    setTimeout(() => HtmlCtrlInterface_PsiCashMessage(msg), 5000);\n  }\n\n  function debugSetPsiCashData(data) {\n    g_PsiCashData = Object.assign(g_PsiCashData, data);\n  }\n\n\n  /* INTERFACE METHODS *********************************************************/\n\n  const PSIPHON_LINK_PREFIX = 'psi:';\n\n  /* Calls from C code to JS code. */\n\n  // Add new status message.\n  function HtmlCtrlInterface_AddLog(jsonArgs) {\n    nextTick(function() {\n      // Allow object as input to assist with debugging\n      const args = _.isObject(jsonArgs) ? jsonArgs : JSON.parse(jsonArgs);\n      addLog(args);\n    });\n  }\n\n  // Add new notice. This may be interpreted and acted upon.\n  function HtmlCtrlInterface_AddNotice(jsonArgs) {\n    nextTick(function() {\n      // Allow object as input to assist with debugging\n      const args = _.isObject(jsonArgs) ? jsonArgs : JSON.parse(jsonArgs);\n      if (args.noticeType === 'UpstreamProxyError') {\n        upstreamProxyErrorNotice(args.data.message);\n      }\n      else if (args.noticeType === 'HttpProxyPortInUse' ||\n               args.noticeType === 'SocksProxyPortInUse') {\n        localProxyPortConflictNotice(args.noticeType);\n      }\n      else if (args.noticeType === 'AvailableEgressRegions') {\n        // Store the value in a cookie so that it's available at the next startup.\n        setCookie('AvailableEgressRegions', args.data.regions);\n        // Update the UI.\n        updateAvailableEgressRegions(true);\n      }\n      else if (args.noticeType === 'ServerAlert') {\n        if (args.data.reason === 'disallowed-traffic') {\n          handleDisallowedTrafficNotice();\n        }\n      }\n      else if (args.noticeType === 'SystemProxySettings::SetProxyError') {\n        showNoticeModal(\n          'notice#systemproxysettings-setproxy-error-title',\n          'notice#systemproxysettings-setproxy-error-body',\n          null, null, null);\n      }\n      else if (args.noticeType === 'SystemProxySettings::SetProxyWarning') {\n        const setProxyWarningTemplate = i18n.t('notice#systemproxysettings-setproxy-warning-template');\n        addLog({\n          priority: 2, // high\n          message: _.template(setProxyWarningTemplate)({data: args.data})\n        });\n      }\n    });\n  }\n\n  // Set the connected state.\n  // We will de-bounce the state change messages.\n  let g_timeoutSetState = null;\n  function HtmlCtrlInterface_SetState(jsonArgs) {\n    // Clear any queued state changes.\n    if (g_timeoutSetState !== null) {\n      clearTimeout(g_timeoutSetState);\n      g_timeoutSetState = null;\n    }\n\n    g_timeoutSetState = setTimeout(function() {\n      g_timeoutSetState = null;\n\n      // Allow object as input to assist with debugging\n      var args = _.isObject(jsonArgs) ? jsonArgs : JSON.parse(jsonArgs);\n      g_lastState = args.state;\n      $window.trigger(CONNECTED_STATE_CHANGE_EVENT);\n    }, 100);\n  }\n\n  // Refresh the current settings values.\n  function HtmlCtrlInterface_RefreshSettings(jsonArgs) {\n    nextTick(function() {\n      var args = JSON.parse(jsonArgs);\n      refreshSettings(args.settings, true);\n\n      if (args.success){\n        if (args.reconnectRequired) {\n          // backend is reconnecting to apply the settings\n          displayCornerAlert($('#settings-apply-alert'));\n        }\n        else {\n          displayCornerAlert($('#settings-save-alert'));\n        }\n      }\n      // else an error occurred when saving settings... TODO: tell user?\n    });\n  }\n\n  // Indicate a DPI-based scaling change.\n  function HtmlCtrlInterface_UpdateDpiScaling(jsonArgs) {\n    DEBUG_LOG('HtmlCtrlInterface_UpdateDpiScaling called');\n\n    // Allow object as input to assist with debugging\n    var args = _.isObject(jsonArgs) ? jsonArgs : JSON.parse(jsonArgs);\n    nextTick(function() {\n      updateDpiScaling(args.dpiScaling);\n    });\n  }\n\n\n  /**\n   * Called from C code when something PsiCash-related occurs, such as a data refresh or\n   * purchase completion.\n   * @param {PsiCashMessageData|string} jsonArgs\n   */\n  function HtmlCtrlInterface_PsiCashMessage(jsonArgs) {\n    nextTick(function() {\n      DEBUG_LOG('HtmlCtrlInterface_PsiCashMessage', jsonArgs);\n\n      let args;\n      try {\n        // Allow object as input to assist with debugging\n        args = _.isObject(jsonArgs) ? jsonArgs : JSON.parse(jsonArgs);\n      }\n      catch(e) {\n        HtmlCtrlInterface_Log('HtmlCtrlInterface_PsiCashMessage: JSON parse failed: ' + e);\n        return;\n      }\n\n      switch (args.type) {\n        case PsiCashMessageTypeEnum.REFRESH:\n          // Payload is PsiCashRefreshData\n          $window.trigger(PsiCashEventTypeEnum.REFRESH, args.payload);\n          break;\n\n        case PsiCashMessageTypeEnum.NEW_PURCHASE:\n          // Payload is PsiCashPurchaseResponse\n          // Nothing special to be done; the promise will be resolved below\n          break;\n\n        case PsiCashMessageTypeEnum.INIT_DONE:\n          // Payload is PsiCashInitDoneData\n          $window.trigger(PsiCashEventTypeEnum.INIT_DONE, args.payload);\n          break;\n      }\n\n      // Resolve any promies that's awaiting this message/response.\n      if (args.id && !_.isUndefined(g_PsiCashCommandIDToResolver[args.id])) {\n        // Trigger a unique event so that the waiting promise can be resolved.\n        g_PsiCashCommandIDToResolver[args.id].call(null, args.payload);\n        delete g_PsiCashCommandIDToResolver[args.id];\n      }\n    });\n  }\n\n  /* Calls from JS code to C code. */\n\n  // Let the C code know that the UI is ready.\n  function HtmlCtrlInterface_AppReady() {\n    nextTick(function() {\n      var appURL = PSIPHON_LINK_PREFIX + 'ready';\n      if (IS_BROWSER) {\n        console.log(appURL);\n      }\n      else {\n        window.location = appURL;\n      }\n\n      $window.trigger(UI_READY_EVENT);\n    });\n  }\n\n  // Give the C code a string table entry in the appropriate language.\n  // `locale` is the locale for this string table.\n  // The `stringtable` can and should be a full set of key:string mappings, but\n  // the strings will be sent to the C code one at a time, to prevent URL size\n  // overflow.\n  function HtmlCtrlInterface_AddStringTableItem(locale, stringtable) {\n    for (var key in stringtable) {\n      if (!stringtable.hasOwnProperty(key)) {\n        continue;\n      }\n\n      var item = {\n        locale: locale,\n        key: key,\n        string: stringtable[key]\n      };\n      sendStringTableItem(item);\n    }\n\n    function sendStringTableItem(itemObj) {\n      nextTick(function() {\n        var appURL = PSIPHON_LINK_PREFIX + 'stringtable?' + encodeURIComponent(JSON.stringify(itemObj));\n        if (IS_BROWSER) {\n          console.log(decodeURIComponent(appURL));\n        }\n        else {\n          window.location = appURL;\n        }\n      });\n    }\n  }\n\n  /**\n   * Add a log entry to the log pane.\n   */\n  function HtmlCtrlInterface_Log() {\n    const msg = Array.prototype.slice.call(arguments).join(' ');\n    nextTick(function() {\n      var appURL = PSIPHON_LINK_PREFIX + 'log?' + encodeURIComponent(msg);\n      if (IS_BROWSER) {\n        console.log(decodeURIComponent(appURL));\n      }\n      else {\n        window.location = appURL;\n      }\n    });\n  }\n\n  // Connection should start.\n  function HtmlCtrlInterface_StartTunnel() {\n    // Prevent duplicate state change attempts\n    if (g_lastState === 'starting' || g_lastState === 'connected') {\n      return;\n    }\n    nextTick(function() {\n      var appURL = PSIPHON_LINK_PREFIX + 'start';\n      if (IS_BROWSER) {\n        console.log(appURL);\n      }\n      else {\n        window.location = appURL;\n      }\n    });\n  }\n\n  // Connection should stop.\n  function HtmlCtrlInterface_StopTunnel() {\n    // Prevent duplicate state change attempts\n    if (g_lastState === 'stopping' || g_lastState === 'disconnected') {\n      return;\n    }\n    nextTick(function() {\n      var appURL = PSIPHON_LINK_PREFIX + 'stop';\n      if (IS_BROWSER) {\n        console.log(appURL);\n      }\n      else {\n        window.location = appURL;\n      }\n    });\n  }\n\n  // The tunnel should be reconnected (if connected or connecting).\n  function HtmlCtrlInterface_ReconnectTunnel(suppressHomePage) {\n    var appURL = PSIPHON_LINK_PREFIX + 'reconnect?suppress=' + (suppressHomePage ? '1' : '0');\n\n    // Prevent duplicate state change attempts\n    if (g_lastState === 'stopping' || g_lastState === 'disconnected') {\n      return;\n    }\n    nextTick(function() {\n      if (IS_BROWSER) {\n        console.log(appURL);\n      }\n      else {\n        window.location = appURL;\n      }\n    });\n  }\n\n  // Settings should be saved.\n  function HtmlCtrlInterface_SaveSettings(settingsJSON) {\n    nextTick(function() {\n      var appURL = PSIPHON_LINK_PREFIX + 'savesettings?' + encodeURIComponent(settingsJSON);\n      if (IS_BROWSER) {\n        console.log(decodeURIComponent(appURL));\n\n        // DEBUG: Make it appear to behave like a real client\n        _.delay(HtmlCtrlInterface_RefreshSettings, 100, JSON.stringify({\n          settings: JSON.parse(settingsJSON),\n          success: true,\n          reconnectRequired: g_lastState === 'connected' || g_lastState === 'starting'\n        }));\n      }\n      else {\n        window.location = appURL;\n      }\n    });\n  }\n\n  // Feedback should be sent.\n  function HtmlCtrlInterface_SendFeedback(feedbackJSON) {\n    nextTick(function() {\n      var appURL = PSIPHON_LINK_PREFIX + 'sendfeedback?' + encodeURIComponent(feedbackJSON);\n      if (IS_BROWSER) {\n        console.log(decodeURIComponent(appURL));\n      }\n      else {\n        window.location = appURL;\n      }\n    });\n  }\n\n  // Cookies (i.e., UI settings) should be saved.\n  function HtmlCtrlInterface_SetCookies(cookiesJSON) {\n    nextTick(function() {\n      var appURL = PSIPHON_LINK_PREFIX + 'setcookies?' + encodeURIComponent(cookiesJSON);\n      if (IS_BROWSER) {\n        console.log(decodeURIComponent(appURL));\n      }\n      else {\n        window.location = appURL;\n      }\n    });\n  }\n\n  // Banner was clicked.\n  function HtmlCtrlInterface_BannerClick() {\n    nextTick(function() {\n      var appURL = PSIPHON_LINK_PREFIX + 'bannerclick';\n      if (IS_BROWSER) {\n        console.log(decodeURIComponent(appURL));\n        alert('Call from JS to C to launch banner URL');\n      }\n      else {\n        window.location = appURL;\n      }\n    });\n  }\n\n  /**\n   * Called when a \"disallowed traffic\" server alert is encountered. The C code will take\n   * steps to make the window visible.\n   */\n  function HtmlCtrlInterface_DisallowedTraffic() {\n    nextTick(function() {\n      var appURL = PSIPHON_LINK_PREFIX + 'disallowedtraffic';\n      if (IS_BROWSER) {\n        console.log(decodeURIComponent(appURL));\n        alert('Call from JS to C in response to disallowed traffic');\n      }\n      else {\n        window.location = appURL;\n      }\n    });\n  }\n\n  /**\n   * Used to communicate Promise resolvers between HtmlCtrlInterface_PsiCashCommand (called\n   * locally) and HtmlCtrlInterface_PsiCashMessage (called from C code).\n   * NOTE: Ideally this would be a map, but our restrictive environment doesn't support them.\n   * @type {Map<string, function>}\n   */\n  let g_PsiCashCommandIDToResolver = {};\n\n  /**\n   * A PsiCash \"command\" should be executed, like purchasing speed boost or refreshing state.\n   * Returns a promise that will be resolved when the command completes.\n   * @param {!PsiCashCommandBase} command\n   * @returns {Promise}\n   */\n  function HtmlCtrlInterface_PsiCashCommand(command) {\n    let commandJSON = JSON.stringify(command);\n\n    let promise = new Promise((resolve) => {\n      g_PsiCashCommandIDToResolver[command.id] = resolve;\n\n      nextTick(function() {\n        let appURL = PSIPHON_LINK_PREFIX + 'psicash?' + encodeURIComponent(commandJSON);\n\n        if (IS_BROWSER) {\n          console.log(decodeURIComponent(appURL));\n          switch (command.command) {\n            case PsiCashCommandEnum.REFRESH:\n              testRefreshResponse(command);\n              break;\n\n            case PsiCashCommandEnum.PURCHASE:\n              testPurchaseResponse(command);\n              break;\n          }\n        }\n        else {\n          window.location = appURL;\n        }\n      });\n    });\n\n    return promise;\n  }\n\n  /* EXPORTS */\n\n  // The C interface code is unable to access functions that are members of objects,\n  // so we'll need to directly expose our exports.\n\n  window.HtmlCtrlInterface_AddLog = HtmlCtrlInterface_AddLog; // @ts-ignore\n  window.HtmlCtrlInterface_SetState = HtmlCtrlInterface_SetState;\n  window.HtmlCtrlInterface_AddNotice = HtmlCtrlInterface_AddNotice;\n  window.HtmlCtrlInterface_RefreshSettings = HtmlCtrlInterface_RefreshSettings;\n  window.HtmlCtrlInterface_UpdateDpiScaling = HtmlCtrlInterface_UpdateDpiScaling;\n  window.HtmlCtrlInterface_PsiCashMessage = HtmlCtrlInterface_PsiCashMessage;\n\n  })(window);\n"],"file":"app.js"}